# IEClub 超级详细开发规划

**版本**: v2.0.0  
**制定时间**: 2025-10-29  
**制定人**: 产品团队 + 技术团队  
**预计完成时间**: 2025-11-19 (3周)

---

## 📊 第一部分：现状分析

### ✅ 已完成工作

#### 1. 后端服务 (完成度: 80%)

**技术栈**:
- ✅ Express 4.18.2
- ✅ Prisma 5.8.0 ORM
- ✅ MySQL 8.0+ 数据库
- ✅ JWT 认证
- ✅ WebSocket 实时通信
- ✅ Redis 缓存

**已实现功能**:
- ✅ 用户认证系统（注册、登录、密码重置）
- ✅ 话题管理（CRUD、点赞、收藏）
- ✅ 评论系统（发表、点赞、回复）
- ✅ 用户系统（资料、关注、粉丝）
- ✅ 搜索功能（话题搜索、用户搜索）
- ✅ 通知系统（点赞、评论、关注通知）
- ✅ 文件上传（图片、文档）
- ✅ 活动管理（基础结构）

**数据库模型**:
```
✅ User         - 用户表（完整）
✅ Topic        - 话题表（完整，支持3种类型）
✅ Comment      - 评论表（完整）
✅ Like         - 点赞表（完整）
✅ Bookmark     - 收藏表（完整）
✅ Follow       - 关注表（完整）
✅ Notification - 通知表（完整）
✅ Activity     - 活动表（完整）
✅ Project      - 项目表（完整）
```

#### 2. 前端框架 (完成度: 50%)

**网页版 (ieclub-web)**:
- ✅ React 18 + Vite
- ✅ Tailwind CSS
- ✅ React Router 6
- ✅ API 请求封装完成
- ✅ 5个核心页面布局
- ⏸️ 数据对接（待完成）
- ⏸️ 详情页（待完成）

**小程序版 (ieclub-taro)**:
- ✅ 原生微信小程序
- ✅ API 请求封装完成
- ✅ 5个核心页面布局
- ⏸️ 数据对接（待完成）
- ⏸️ 详情页（待完成）

#### 3. 基础设施

- ✅ Docker 容器化
- ✅ Nginx 反向代理配置
- ✅ MySQL 数据库配置
- ✅ Redis 缓存配置
- ✅ 日志系统（Winston）
- ✅ 测试框架（Jest）

---

### 🎯 需要完成的工作

#### 优先级分级

**P0 - 核心功能（必须有）**:
1. 用户登录/注册（双端）
2. 话题发布功能
3. 话题列表展示
4. 话题详情页
5. 点赞功能
6. 评论功能
7. 用户关注功能

**P1 - 重要功能（应该有）**:
1. 活动报名功能
2. 搜索功能
3. 消息通知
4. 个人中心完善
5. 图片上传
6. 下拉刷新/上拉加载

**P2 - 增强功能（可以有）**:
1. 排行榜
2. 勋章系统
3. 数据统计
4. 分享功能
5. 举报功能

---

## 📅 第二部分：3周开发计划

### Week 1: 基础功能（11.29 - 11.04）

#### Day 1-2: API 对接准备 ✅ **已完成**

**完成内容**:
- ✅ 网页版请求封装（`ieclub-web/src/utils/request.js`）
- ✅ 小程序请求封装（`ieclub-taro/utils/request.js`）
- ✅ API 模块化（auth.js, topic.js, user.js）
- ✅ 统一错误处理
- ✅ Token 自动注入

#### Day 3: 用户登录 - 小程序版 🔥 **今天开始**

**目标**: 实现小程序微信授权登录

**任务清单**:

**1. 创建登录页面**

文件: `ieclub-taro/pages/login/index.js`

```javascript
// pages/login/index.js
import { wechatLogin } from '../../api/auth'

Page({
  data: {
    userInfo: null,
    hasUserInfo: false,
    canIUseGetUserProfile: wx.canIUse('getUserProfile')
  },

  onLoad() {
    console.log('登录页加载')
    // 检查是否已登录
    const token = wx.getStorageSync('token')
    if (token) {
      wx.reLaunch({
        url: '/pages/plaza/index'
      })
    }
  },

  // 微信授权登录
  async onWechatLogin() {
    try {
      // 1. 获取用户授权信息
      const { userInfo } = await this.getUserProfile()
      
      // 2. 获取微信登录凭证
      const { code } = await this.getWxCode()
      
      // 3. 调用后端登录接口
      const result = await wechatLogin({
        code,
        userInfo
      })
      
      // 4. 保存 Token 和用户信息
      wx.setStorageSync('token', result.token)
      wx.setStorageSync('userInfo', result.user)
      
      // 5. 跳转到首页
      wx.showToast({
        title: '登录成功',
        icon: 'success'
      })
      
      setTimeout(() => {
        wx.reLaunch({
          url: '/pages/plaza/index'
        })
      }, 1500)
      
    } catch (error) {
      console.error('登录失败:', error)
      wx.showToast({
        title: error.message || '登录失败',
        icon: 'none'
      })
    }
  },

  // 获取用户授权信息
  getUserProfile() {
    return new Promise((resolve, reject) => {
      if (this.data.canIUseGetUserProfile) {
        wx.getUserProfile({
          desc: '用于完善会员资料',
          success: resolve,
          fail: reject
        })
      } else {
        reject(new Error('当前微信版本过低'))
      }
    })
  },

  // 获取微信登录凭证
  getWxCode() {
    return new Promise((resolve, reject) => {
      wx.login({
        success: resolve,
        fail: reject
      })
    })
  }
})
```

文件: `ieclub-taro/pages/login/index.wxml`

```xml
<!--pages/login/index.wxml-->
<view class="login-page">
  <view class="login-container">
    <!-- Logo 区域 -->
    <view class="logo-section">
      <view class="logo">IE</view>
      <text class="app-name">IEClub</text>
      <text class="slogan">创造线上线下交互的无限可能</text>
    </view>

    <!-- 功能介绍 -->
    <view class="features">
      <view class="feature-item">
        <text class="feature-icon">🎤</text>
        <text class="feature-label">我来讲</text>
        <text class="feature-desc">分享知识</text>
      </view>
      <view class="feature-item">
        <text class="feature-icon">👂</text>
        <text class="feature-label">想听</text>
        <text class="feature-desc">学习需求</text>
      </view>
      <view class="feature-item">
        <text class="feature-icon">🚀</text>
        <text class="feature-label">项目</text>
        <text class="feature-desc">创业宣传</text>
      </view>
    </view>

    <!-- 登录按钮 -->
    <button class="login-btn" bindtap="onWechatLogin">
      <text class="btn-icon">👤</text>
      <text class="btn-text">微信授权登录</text>
    </button>

    <!-- 协议说明 -->
    <view class="agreement">
      <text class="agreement-text">登录即表示同意</text>
      <text class="agreement-link">《用户协议》</text>
      <text class="agreement-text">和</text>
      <text class="agreement-link">《隐私政策》</text>
    </view>
  </view>
</view>
```

文件: `ieclub-taro/pages/login/index.wxss`

```css
/* pages/login/index.wxss */
.login-page {
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 60rpx 40rpx;
}

.login-container {
  width: 100%;
}

/* Logo 区域 */
.logo-section {
  text-align: center;
  margin-bottom: 80rpx;
}

.logo {
  width: 160rpx;
  height: 160rpx;
  line-height: 160rpx;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 40rpx;
  margin: 0 auto 30rpx;
  font-size: 72rpx;
  font-weight: bold;
  color: #667eea;
  box-shadow: 0 8rpx 24rpx rgba(0, 0, 0, 0.15);
}

.app-name {
  display: block;
  font-size: 48rpx;
  font-weight: bold;
  color: #fff;
  margin-bottom: 16rpx;
}

.slogan {
  display: block;
  font-size: 26rpx;
  color: rgba(255, 255, 255, 0.85);
}

/* 功能介绍 */
.features {
  display: flex;
  justify-content: space-around;
  margin-bottom: 80rpx;
}

.feature-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 30rpx 20rpx;
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(10rpx);
  border-radius: 20rpx;
  min-width: 180rpx;
}

.feature-icon {
  font-size: 60rpx;
  margin-bottom: 12rpx;
}

.feature-label {
  font-size: 28rpx;
  font-weight: bold;
  color: #fff;
  margin-bottom: 8rpx;
}

.feature-desc {
  font-size: 22rpx;
  color: rgba(255, 255, 255, 0.8);
}

/* 登录按钮 */
.login-btn {
  width: 100%;
  padding: 32rpx 0;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 100rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8rpx 24rpx rgba(0, 0, 0, 0.2);
  margin-bottom: 40rpx;
}

.login-btn:active {
  opacity: 0.9;
  transform: scale(0.98);
}

.btn-icon {
  font-size: 36rpx;
  margin-right: 12rpx;
}

.btn-text {
  font-size: 32rpx;
  font-weight: bold;
  color: #667eea;
}

/* 协议说明 */
.agreement {
  text-align: center;
  font-size: 22rpx;
  color: rgba(255, 255, 255, 0.7);
}

.agreement-text {
  color: rgba(255, 255, 255, 0.7);
}

.agreement-link {
  color: #fff;
  text-decoration: underline;
}
```

文件: `ieclub-taro/pages/login/index.json`

```json
{
  "navigationBarTitleText": "登录",
  "navigationStyle": "custom",
  "usingComponents": {}
}
```

**2. 更新 app.json**

添加登录页到页面列表：

```json
{
  "pages": [
    "pages/login/index",
    "pages/plaza/index",
    "pages/community/index",
    "pages/publish/index",
    "pages/activities/index",
    "pages/profile/index"
  ]
}
```

**3. 更新后端登录接口**

检查 `ieclub-backend/src/controllers/authController.js` 是否支持微信登录。

如果没有，需要添加：

```javascript
// 微信小程序登录
static async wechatLogin(req, res, next) {
  try {
    const { code, userInfo } = req.body

    // 1. 用微信code换取 openid 和 session_key
    const wxLoginUrl = `https://api.weixin.qq.com/sns/jscode2session?appid=${process.env.WX_APP_ID}&secret=${process.env.WX_APP_SECRET}&js_code=${code}&grant_type=authorization_code`
    
    const wxResponse = await axios.get(wxLoginUrl)
    const { openid, session_key, unionid } = wxResponse.data
    
    if (!openid) {
      throw new Error('微信登录失败')
    }

    // 2. 查找或创建用户
    let user = await prisma.user.findUnique({
      where: { openid }
    })

    if (!user) {
      // 创建新用户
      user = await prisma.user.create({
        data: {
          openid,
          unionid,
          sessionKey: session_key,
          nickname: userInfo.nickName,
          avatar: userInfo.avatarUrl,
          gender: userInfo.gender
        }
      })
    } else {
      // 更新用户信息
      user = await prisma.user.update({
        where: { id: user.id },
        data: {
          sessionKey: session_key,
          nickname: userInfo.nickName,
          avatar: userInfo.avatarUrl,
          lastLoginAt: new Date()
        }
      })
    }

    // 3. 生成 JWT Token
    const token = jwt.sign(
      { userId: user.id, openid: user.openid },
      process.env.JWT_SECRET,
      { expiresIn: '30d' }
    )

    res.json({
      code: 200,
      message: '登录成功',
      data: {
        token,
        user: {
          id: user.id,
          nickname: user.nickname,
          avatar: user.avatar,
          level: user.level
        }
      }
    })
  } catch (error) {
    next(error)
  }
}
```

**验收标准**:
- ✅ 用户可以点击登录按钮
- ✅ 微信授权弹窗正常显示
- ✅ 登录成功后保存 Token
- ✅ 自动跳转到首页
- ✅ Token 过期后自动跳转登录页

---

#### Day 4: 用户登录 - 网页版

**目标**: 实现网页版手机号验证码登录

**任务清单**:

**1. 创建登录页面**

文件: `ieclub-web/src/pages/Login.jsx`

```javascript
import { useState } from 'react'
import { useNavigate } from 'react-router-dom'
import { sendCode, login } from '../api/auth'

export default function Login() {
  const navigate = useNavigate()
  const [phone, setPhone] = useState('')
  const [code, setCode] = useState('')
  const [countdown, setCountdown] = useState(0)
  const [loading, setLoading] = useState(false)

  // 发送验证码
  const handleSendCode = async () => {
    if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
      alert('请输入正确的手机号')
      return
    }

    if (countdown > 0) return

    try {
      await sendCode(phone)
      alert('验证码已发送')
      // 开始倒计时
      setCountdown(60)
      const timer = setInterval(() => {
        setCountdown(prev => {
          if (prev <= 1) {
            clearInterval(timer)
            return 0
          }
          return prev - 1
        })
      }, 1000)
    } catch (error) {
      alert(error.message)
    }
  }

  // 登录
  const handleLogin = async (e) => {
    e.preventDefault()

    if (!phone || !code) {
      alert('请输入手机号和验证码')
      return
    }

    setLoading(true)
    try {
      const result = await login(phone, code)
      // 保存 Token 和用户信息
      localStorage.setItem('token', result.token)
      localStorage.setItem('userInfo', JSON.stringify(result.user))
      // 跳转到首页
      navigate('/plaza')
    } catch (error) {
      alert(error.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen bg-gradient-primary flex items-center justify-center px-6">
      <div className="w-full max-w-md">
        {/* Logo 区域 */}
        <div className="text-center mb-12">
          <div className="w-20 h-20 bg-white rounded-2xl mx-auto mb-4 flex items-center justify-center">
            <span className="text-4xl font-bold text-purple-600">IE</span>
          </div>
          <h1 className="text-4xl font-bold text-white mb-2">IEClub</h1>
          <p className="text-white/80 text-sm">创造线上线下交互的无限可能</p>
        </div>

        {/* 登录表单 */}
        <form onSubmit={handleLogin} className="bg-white rounded-3xl p-8 shadow-2xl">
          <h2 className="text-2xl font-bold text-gray-900 mb-6">手机号登录</h2>

          {/* 手机号输入 */}
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              手机号
            </label>
            <input
              type="tel"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              placeholder="请输入手机号"
              className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
            />
          </div>

          {/* 验证码输入 */}
          <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              验证码
            </label>
            <div className="flex gap-3">
              <input
                type="text"
                value={code}
                onChange={(e) => setCode(e.target.value)}
                placeholder="请输入验证码"
                className="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
              <button
                type="button"
                onClick={handleSendCode}
                disabled={countdown > 0}
                className="px-6 py-3 bg-purple-100 text-purple-600 rounded-xl font-medium disabled:opacity-50"
              >
                {countdown > 0 ? `${countdown}s` : '获取验证码'}
              </button>
            </div>
          </div>

          {/* 登录按钮 */}
          <button
            type="submit"
            disabled={loading}
            className="w-full bg-gradient-primary text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition-all disabled:opacity-50"
          >
            {loading ? '登录中...' : '登录'}
          </button>

          {/* 协议 */}
          <p className="text-xs text-gray-500 text-center mt-6">
            登录即表示同意
            <a href="#" className="text-purple-600">《用户协议》</a>
            和
            <a href="#" className="text-purple-600">《隐私政策》</a>
          </p>
        </form>
      </div>
    </div>
  )
}
```

**2. 添加路由**

在 `ieclub-web/src/App.jsx` 中添加登录路由：

```javascript
import Login from './pages/Login'

function App() {
  return (
    <Routes>
      <Route path="/login" element={<Login />} />
      <Route path="/" element={<Layout />}>
        {/* ... 其他路由 */}
      </Route>
    </Routes>
  )
}
```

**3. 添加路由守卫**

创建 `ieclub-web/src/components/PrivateRoute.jsx`：

```javascript
import { Navigate } from 'react-router-dom'

export default function PrivateRoute({ children }) {
  const token = localStorage.getItem('token')
  
  if (!token) {
    return <Navigate to="/login" replace />
  }
  
  return children
}
```

**验收标准**:
- ✅ 手机号格式验证
- ✅ 验证码倒计时
- ✅ 登录成功保存 Token
- ✅ 自动跳转到首页
- ✅ 未登录自动跳转登录页

---

#### Day 5: 话题列表数据对接

**目标**: 双端话题列表显示真实数据

**小程序版更新**:

```javascript
// ieclub-taro/pages/plaza/index.js
import { getTopics } from '../../api/topic'

Page({
  data: {
    activeTab: 'all',
    topics: [],
    loading: false,
    page: 1,
    hasMore: true
  },

  onLoad() {
    this.loadTopics()
  },

  // 加载话题列表
  async loadTopics(reset = false) {
    if (this.data.loading) return

    this.setData({ loading: true })

    try {
      const page = reset ? 1 : this.data.page
      const result = await getTopics({
        type: this.data.activeTab,
        page,
        limit: 20
      })

      this.setData({
        topics: reset ? result.list : [...this.data.topics, ...result.list],
        page: page + 1,
        hasMore: result.list.length >= 20,
        loading: false
      })
    } catch (error) {
      console.error('加载失败:', error)
      this.setData({ loading: false })
    }
  },

  // 切换 Tab
  switchTab(e) {
    const { tab } = e.currentTarget.dataset
    this.setData({ activeTab: tab })
    this.loadTopics(true)
  },

  // 下拉刷新
  onPullDownRefresh() {
    this.loadTopics(true)
    wx.stopPullDownRefresh()
  },

  // 上拉加载更多
  onReachBottom() {
    if (this.data.hasMore && !this.data.loading) {
      this.loadTopics()
    }
  }
})
```

**网页版更新**:

```javascript
// ieclub-web/src/pages/Plaza.jsx
import { useState, useEffect } from 'react'
import { getTopics } from '../api/topic'

export default function Plaza() {
  const [activeTab, setActiveTab] = useState('all')
  const [topics, setTopics] = useState([])
  const [loading, setLoading] = useState(false)

  // 加载话题列表
  const loadTopics = async () => {
    setLoading(true)
    try {
      const result = await getTopics({
        type: activeTab,
        page: 1,
        limit: 20
      })
      setTopics(result.list)
    } catch (error) {
      console.error('加载失败:', error)
    } finally {
      setLoading(false)
    }
  }

  // Tab 切换时重新加载
  useEffect(() => {
    loadTopics()
  }, [activeTab])

  // ... rest of component
}
```

---

### Week 2: 核心功能（11.05 - 11.11）

详细规划省略，包含：
- Day 6-7: 话题发布功能
- Day 8-9: 话题详情页
- Day 10-11: 评论功能
- Day 12: 用户关注功能

### Week 3: 完善测试（11.12 - 11.18）

详细规划省略，包含：
- Day 13-14: 活动功能
- Day 15-16: 集成测试
- Day 17-18: Bug 修复
- Day 19-21: 优化上线

---

## 🎯 立即开始

### 今天的任务（Day 3）

✅ **已完成**: API 封装  
🔥 **进行中**: 小程序登录功能

### 下一步

1. 创建登录页面文件
2. 实现微信授权登录
3. 测试登录流程
4. 明天实现网页版登录

---

需要我立即开始创建登录页面代码吗？

