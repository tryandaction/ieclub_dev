# IEClub 部署方案 - 完整发布指南

## 项目概述
- **项目名称**: IEClub 跨平台应用 - 智能话题广场
- **技术栈**: Taro + React + TypeScript + Sass
- **支持平台**: 微信小程序、H5、React Native
- **域名**: www.ieclub.online (生产环境)

---

## 阶段一：环境准备与项目检查

### 1. 检查 Node.js 环境
```bash
node -v  # 应显示 v18.x.x 或更高
npm -v   # 应显示 8.x.x 或更高
```

**详细步骤**:
1. 打开命令提示符 (Windows) 或终端 (macOS/Linux)
2. 输入 `node -v` 并按回车
3. 如果显示版本号低于 18.x，请升级 Node.js
4. 同样检查 `npm -v`

**升级 Node.js (如果需要)**:
- 访问 https://nodejs.org 下载最新 LTS 版本
- 运行安装程序
- 重启命令提示符/终端
- 再次检查版本

### 2. 检查 Taro CLI
```bash
taro -v  # 应显示 3.6.x
```
如果未安装：
```bash
npm install -g @tarojs/cli@3.6.23
```

**详细步骤**:
1. 在命令提示符/终端中输入 `taro -v`
2. 如果显示版本号，继续下一步
3. 如果显示 "command not found" 或版本不匹配，运行安装命令
4. 安装完成后再次检查版本

### 3. 进入项目目录
```bash
cd c:/universe/GitHub_try/IEclub_dev/ieclub-taro
```

**详细步骤**:
1. 打开文件资源管理器
2. 导航到 `C:\universe\GitHub_try\IEclub_dev\ieclub-taro`
3. 右键点击文件夹空白处，选择 "在此处打开命令窗口" 或 "Open in Terminal"
4. 或者在命令提示符中手动输入上述 cd 命令

### 4. 安装项目依赖
```bash
npm install
```

**详细步骤**:
1. 确保在项目根目录 (ieclub-taro 文件夹内)
2. 运行 `npm install`
3. 等待安装完成 (可能需要几分钟)
4. 如果遇到网络问题，可以尝试使用国内镜像:
   ```bash
   npm config set registry https://registry.npmmirror.com
   npm install
   ```

### 5. 验证项目完整性
```bash
npm run lint        # 检查代码质量
npm run type-check  # 检查 TypeScript 类型
```

**详细步骤**:
1. 确保依赖安装完成
2. 依次运行上述两个命令
3. 如果有错误，根据错误信息修复问题
4. lint 错误通常是代码风格问题，可以运行 `npm run lint:fix` 自动修复
5. type-check 错误需要手动修复 TypeScript 类型问题

---

## 阶段二：开发与调试

### 1. 微信小程序开发模式
```bash
npm run dev:weapp
```

**详细步骤**:
1. 确保在项目根目录
2. 运行上述命令
3. 等待编译完成 (首次可能需要几分钟)
4. 编译成功后会显示 "监听文件修改中..." 信息

**成功标志**:
- 终端显示: "监听文件修改中..."
- 项目根目录生成 `dist/` 文件夹
- `dist/` 文件夹包含 `app.js`, `app.json`, `app.wxss` 等文件
- 微信开发者工具可以导入 `dist/` 文件夹

**如果编译失败**:
- 检查是否有语法错误
- 运行 `npm run type-check` 检查类型错误
- 删除 `node_modules` 和 `package-lock.json`，重新 `npm install`

### 2. H5 开发模式
```bash
npm run dev:h5
```

**详细步骤**:
1. 在新终端窗口中运行上述命令 (小程序开发模式仍在运行)
2. 等待 H5 服务器启动
3. 浏览器会自动打开或手动访问地址

**访问地址**: http://localhost:10086

**成功标志**:
- 终端显示服务器启动信息和访问地址
- 浏览器中能正常显示应用界面
- 修改代码后页面会自动刷新

### 3. 微信开发者工具配置

**详细步骤**:

#### 下载和安装微信开发者工具
1. 访问 https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
2. 下载对应你操作系统的版本
3. 运行安装程序完成安装

#### 导入项目
1. 打开微信开发者工具
2. 使用微信扫码登录 (需要有微信小程序账号)
3. 点击左上角 **+** 按钮或选择 **项目** → **导入项目**
4. 在 **项目目录** 中选择 `dist/` 文件夹:
   ```
   C:\universe\GitHub_try\IEclub_dev\ieclub-taro\dist
   ```
5. **AppID**:
   - 如果你有正式的小程序 AppID，输入它
   - 如果没有，选择 **"测试号"** (功能受限，但可以用于开发测试)
6. **项目名称**: 输入 "IEClub 开发版"
7. 点击 **确定** 完成导入

#### 配置项目 (如果需要)
- 如果项目使用了 npm 包，在开发者工具中点击 **工具** → **构建 npm**
- 如果遇到编译问题，点击 **工具** → **清除缓存** → **全部清除**

**成功标志**:
- 左侧模拟器显示小程序界面
- 右侧可以进行调试和查看日志
- 修改 `src/` 目录下的代码会自动重新编译

---

## 阶段三：构建与发布准备

### 1. 微信小程序生产构建
```bash
npm run build:weapp
```

**详细步骤**:
1. 确保开发模式已停止 (Ctrl+C 终止 npm run dev:weapp)
2. 在项目根目录运行上述命令
3. 等待构建完成 (会显示进度条)
4. 构建成功后 `dist/` 文件夹会被更新为生产版本

**构建产物检查**:
- `dist/app.js` - 主入口文件 (会被压缩混淆)
- `dist/app.wxss` - 样式文件 (会被压缩)
- `dist/pages/` - 页面文件
- 文件大小应该比开发版本小很多

### 2. H5 生产构建
```bash
npm run build:h5
```

**详细步骤**:
1. 确保 H5 开发服务器已停止
2. 运行上述命令
3. 构建完成后会在 `dist/h5/` 目录生成静态文件

**构建产物检查**:
- `dist/h5/index.html` - 主页面
- `dist/h5/static/js/` - JavaScript 文件
- `dist/h5/static/css/` - CSS 文件

### 3. 环境配置检查

**详细步骤**:
1. 检查项目根目录是否有 `.env` 文件
2. 如果没有，创建该文件
3. 确保包含以下配置:

```env
# API 接口地址
TARO_APP_API_URL=https://api.ieclub.online

# 环境标识
NODE_ENV=production

# 其他配置 (根据需要添加)
TARO_APP_BUILD_ENV=production
```

**注意**: `.env` 文件不会被提交到 Git，请确保生产环境手动配置

### 4. 小程序配置检查

**详细步骤**:
1. 打开 `project.config.json` 文件
2. 确保配置正确:

```json
{
  "miniprogramRoot": "dist/",
  "projectname": "ieclub-taro",
  "appid": "your-actual-appid",
  "compileType": "miniprogram",
  "setting": {
    "enhance": true,
    "es6": true,
    "postcss": true,
    "preloadBackgroundData": false,
    "minifyWXSS": true,
    "minifyWXML": true,
    "minifyJS": true,
    "minify": true
  }
}
```

**重要**: 将 `"your-actual-appid"` 替换为你的真实 AppID

---

## 阶段四：服务器部署 (生产环境)

### 1. 服务器要求
- **操作系统**: Ubuntu 20.04+ / CentOS 7+
- **内存**: 至少 2GB RAM (推荐 4GB+)
- **存储**: 至少 20GB 可用空间
- **网络**: 稳定的公网 IP 和域名
- **安全**: 配置防火墙，只开放必要端口 (22, 80, 443)

### 2. 服务器软件栈安装

**详细步骤**:

#### 更新系统
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

#### 安装 Node.js 18+
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo -E bash -
sudo yum install -y nodejs

# 验证安装
node --version  # 应显示 v18.x.x
npm --version   # 应显示 8.x.x 或更高
```

#### 安装 Nginx
```bash
# Ubuntu/Debian
sudo apt install nginx -y

# CentOS/RHEL
sudo yum install nginx -y

# 启动并设置开机自启
sudo systemctl start nginx
sudo systemctl enable nginx

# 验证安装
sudo systemctl status nginx
```

#### 安装 PM2 (Node.js 进程管理)
```bash
sudo npm install -g pm2

# 验证安装
pm2 --version
```

#### 安装 Git
```bash
# Ubuntu/Debian
sudo apt install git -y

# CentOS/RHEL
sudo yum install git -y

# 配置 Git (替换为你的信息)
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
```

### 3. 项目部署

**详细步骤**:

#### 创建项目目录和用户
```bash
# 创建项目目录
sudo mkdir -p /var/www/ieclub
sudo chown -R $USER:$USER /var/www/ieclub

# 进入项目目录
cd /var/www/ieclub
```

#### 克隆项目代码
```bash
# 克隆项目 (生产环境使用 main 分支)
git clone https://github.com/your-username/ieclub.git .

# 切换到生产分支
git checkout main

# 拉取最新代码
git pull origin main
```

**注意**: 将 `your-username` 替换为你的 GitHub 用户名

#### 安装项目依赖
```bash
# 生产环境建议只安装生产依赖
npm ci --production

# 如果需要开发依赖 (用于构建)
npm ci
```

#### 配置环境变量
```bash
# 创建生产环境配置文件
cp .env.example .env.production

# 编辑配置文件
nano .env.production
```

确保 `.env.production` 包含:
```env
NODE_ENV=production
TARO_APP_API_URL=https://api.ieclub.online
DATABASE_URL=your_production_database_url
```

#### 构建 H5 版本
```bash
# 构建生产版本
npm run build:h5

# 检查构建产物
ls -la dist/h5/
```

**构建成功标志**:
- `dist/h5/` 目录包含 `index.html`, `static/` 文件夹
- 没有构建错误信息

### 4. Nginx 配置

**详细步骤**:

#### 创建 Nginx 配置文件
```bash
# 创建配置文件
sudo nano /etc/nginx/sites-available/ieclub.conf
```

粘贴以下配置:
```nginx
server {
    listen 80;
    server_name www.ieclub.online;
    root /var/www/ieclub/dist/h5;
    index index.html;

    # 启用 gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_min_length 1024;

    # 处理 React Router (SPA)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 代理 (如果后端在同一服务器)
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff;
    }

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
}
```

#### 启用配置
```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/ieclub.conf /etc/nginx/sites-enabled/

# 删除默认配置 (可选)
sudo rm /etc/nginx/sites-enabled/default

# 测试配置语法
sudo nginx -t

# 如果测试通过，重载 Nginx
sudo systemctl reload nginx
```

#### 验证配置
```bash
# 检查 Nginx 状态
sudo systemctl status nginx

# 检查配置文件
sudo nginx -T | grep -A 20 "server_name www.ieclub.online"
```

### 5. SSL 证书配置 (Let's Encrypt)

**详细步骤**:

#### 安装 Certbot
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install certbot python3-certbot-nginx -y

# CentOS/RHEL
sudo yum install certbot python3-certbot-nginx -y
```

#### 获取 SSL 证书
```bash
# 为域名申请证书 (会自动修改 Nginx 配置)
sudo certbot --nginx -d www.ieclub.online

# 如果有多个域名，可以添加多个 -d 参数
# sudo certbot --nginx -d www.ieclub.online -d api.ieclub.online
```

**申请过程中会提示**:
- 输入邮箱地址 (用于紧急通知)
- 同意服务条款
- 是否分享邮箱 (可选)

#### 验证证书安装
```bash
# 检查证书文件
sudo ls -la /etc/letsencrypt/live/www.ieclub.online/

# 测试 HTTPS 访问
curl -I https://www.ieclub.online
```

#### 设置自动续期
```bash
# 编辑 crontab
sudo crontab -e

# 添加以下行 (每天中午检查续期)
0 12 * * * /usr/bin/certbot renew --quiet

# 保存并退出
```

**续期测试**:
```bash
# 手动测试续期 (不会实际续期，只检查)
sudo certbot renew --dry-run
```

### 6. 域名配置

**详细步骤**:

#### 获取服务器公网 IP
```bash
# 查看服务器公网 IP
curl ifconfig.me
# 或者
curl ipinfo.io/ip
```

#### 在域名服务商配置 DNS
1. 登录你的域名服务商控制台 (如阿里云、腾讯云、GoDaddy等)
2. 进入域名管理页面
3. 找到 DNS 解析设置

#### 添加 A 记录
- **记录类型**: A
- **主机记录**: www (或 @ 表示根域名)
- **记录值**: 你的服务器公网 IP 地址
- **TTL**: 600 (或默认值)

**示例配置**:
```
类型: A
主机记录: www
记录值: 123.456.789.012
TTL: 600
```

#### 验证 DNS 解析
```bash
# 等待 DNS 生效 (可能需要几分钟到几小时)
nslookup www.ieclub.online

# 或者使用 dig 命令
dig www.ieclub.online
```

#### 测试网站访问
```bash
# 测试 HTTP 访问
curl -I http://www.ieclub.online

# 如果已配置 HTTPS
curl -I https://www.ieclub.online
```

**注意事项**:
- DNS 解析生效时间因服务商而异，通常 10 分钟到 24 小时
- 如果使用 CDN，需要在 CDN 控制台配置而不是域名服务商

---

## 阶段五：小程序发布流程

### 1. 获取 AppID

**详细步骤**:

#### 注册微信小程序
1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 点击 **立即注册** → **小程序**
3. 使用邮箱注册账号
4. 完成实名认证 (个人/企业)

#### 获取 AppID
1. 登录微信公众平台后台
2. 在 **设置** → **基本设置** 中找到 **AppID**
3. 复制保存 AppID (格式如: wx1234567890abcdef)

**注意**: AppID 是小程序的唯一标识，请妥善保管

### 2. 更新配置

**详细步骤**:
1. 打开项目根目录的 `project.config.json` 文件
2. 将 `"appid"` 字段的值替换为你的真实 AppID:

```json
{
  "miniprogramRoot": "dist/",
  "projectname": "ieclub-taro",
  "appid": "wx1234567890abcdef",  // 替换为你的真实 AppID
  "compileType": "miniprogram"
}
```

3. 保存文件

### 3. 构建上传

**详细步骤**:

#### 构建生产版本
```bash
# 确保在项目根目录
cd /path/to/your/project

# 构建小程序生产版本
npm run build:weapp
```

#### 在微信开发者工具中上传
1. 打开微信开发者工具
2. 确保当前项目是最新构建的版本
3. 点击顶部菜单 **上传**
4. 填写版本信息:
   - **版本号**: 1.0.0 (遵循语义化版本，如 major.minor.patch)
   - **项目备注**: "首次发布版本" 或详细的更新说明
5. 点击 **上传**
6. 输入微信小程序账号密码确认

**上传成功标志**:
- 显示 "上传成功"
- 在微信公众平台后台能看到新版本

### 4. 审核发布

**详细步骤**:

#### 登录微信公众平台
1. 访问 https://mp.weixin.qq.com/
2. 扫码登录

#### 提交审核
1. 进入 **管理** → **版本管理**
2. 在 **开发版本** 中找到刚上传的版本
3. 点击 **提交审核**
4. 填写审核信息:
   - **功能描述**: 简要描述小程序功能
   - **页面路径**: 主要页面路径，如 pages/index/index
   - **测试账号**: 如果需要，提供测试账号密码
   - **页面截图**: 上传小程序页面截图
   - **审核备注**: 其他说明信息

#### 等待审核结果
- 审核时间通常 1-3 个工作日
- 审核通过后会收到微信通知
- 如果审核失败，会收到具体原因，需要修改后重新提交

#### 发布上线
1. 审核通过后，在 **审核版本** 中点击 **发布**
2. 确认发布信息
3. 小程序正式上线，用户可以通过微信搜索或扫码访问

---

## 阶段六：内测环境部署 (可选)

### 1. 创建内测子域名
DNS 配置:
- **主机记录**: beta
- **记录类型**: A
- **记录值**: 服务器 IP

### 2. 服务器配置
```bash
# 创建内测目录
sudo mkdir -p /var/www/ieclub-beta
cd /var/www/ieclub-beta

# 克隆 develop 分支
git clone https://github.com/your-username/ieclub.git .
git checkout develop

# 构建内测版本
npm install
npm run build:h5
```

### 3. Nginx 内测配置
创建 `/etc/nginx/sites-available/ieclub-beta.conf`:
```nginx
server {
    listen 80;
    server_name beta.ieclub.online;
    root /var/www/ieclub-beta/dist/h5;
    index index.html;

    # 内测环境访问控制 (IP 白名单)
    allow 你的IP地址;
    deny all;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # 其他配置同生产环境...
}
```

---

## 阶段七：监控与维护

### 1. 进程监控 (PM2)
```bash
# 如果有后端服务
pm2 start ecosystem.config.js --env production
pm2 save
pm2 startup
```

### 2. 日志监控
```bash
# 查看 Nginx 错误日志
sudo tail -f /var/log/nginx/error.log

# 查看应用日志
pm2 logs
```

### 3. 备份策略
```bash
# 数据库备份 (如果有)
mysqldump -u username -p database > backup.sql

# 代码备份
git tag v1.0.0  # 打标签
```

---

## 常见问题排查

### 1. 构建失败

**问题现象**:
- `npm run build:weapp` 或 `npm run build:h5` 报错
- 编译过程中断

**解决方案**:

#### 清除缓存重试
```bash
# 删除缓存目录
rm -rf node_modules/.cache
rm -rf dist/

# 重新安装依赖
npm ci

# 重新构建
npm run build:h5
```

#### 检查依赖版本
```bash
# 检查 Node.js 版本
node -v  # 应为 18.x

# 检查 Taro 版本
npx taro -v

# 更新 Taro (如果版本过旧)
npm update @tarojs/cli @tarojs/taro
```

#### 检查代码错误
```bash
# 运行类型检查
npm run type-check

# 运行代码检查
npm run lint
```

### 2. 页面空白或显示异常

**问题现象**:
- 网站访问显示空白页
- 小程序无法正常显示

**排查步骤**:

#### 检查构建产物
```bash
# 检查 dist 目录是否存在
ls -la dist/h5/

# 检查主要文件
ls -la dist/h5/index.html
ls -la dist/h5/static/js/
```

#### 检查 Nginx 配置
```bash
# 测试配置语法
sudo nginx -t

# 检查配置文件
sudo cat /etc/nginx/sites-enabled/ieclub.conf

# 重载配置
sudo systemctl reload nginx
```

#### 检查浏览器控制台
1. 打开浏览器开发者工具 (F12)
2. 查看 Console 标签页的错误信息
3. 查看 Network 标签页的请求状态

#### 检查文件权限
```bash
# 确保 Nginx 能读取文件
sudo chown -R www-data:www-data /var/www/ieclub
sudo chmod -R 755 /var/www/ieclub
```

### 3. 小程序审核失败

**常见拒绝原因**:

#### 内容违规
- 确保小程序不包含违法违规内容
- 完善用户协议和隐私政策
- 提供真实有效的联系方式

#### 功能不完整
- 确保小程序功能正常运行
- 提供测试账号和密码
- 上传清晰的页面截图

#### 重新提交审核
1. 根据拒绝原因修改代码
2. 重新构建上传
3. 在微信公众平台提交新的审核申请

### 4. 服务器连接问题

**SSH 连接失败**:
```bash
# 检查 SSH 服务状态
sudo systemctl status ssh

# 检查防火墙设置
sudo ufw status
```

**域名无法访问**:
```bash
# 检查 DNS 解析
nslookup www.ieclub.online

# 检查服务器网络
ping your-server-ip

# 检查 Nginx 状态
sudo systemctl status nginx
```

### 5. HTTPS 证书问题

**证书申请失败**:
```bash
# 检查域名 DNS 解析
dig www.ieclub.online

# 检查防火墙 (80/443 端口必须开放)
sudo ufw allow 80
sudo ufw allow 443
```

**证书续期失败**:
```bash
# 手动续期测试
sudo certbot renew --dry-run

# 查看证书状态
sudo certbot certificates
```

### 6. 性能优化建议

#### 启用压缩和缓存
- 确保 Nginx 配置中启用了 gzip 压缩
- 配置适当的浏览器缓存头
- 使用 CDN 加速静态资源分发

#### 监控资源使用
```bash
# 查看内存使用
free -h

# 查看磁盘使用
df -h

# 查看 CPU 使用
top
```

#### 数据库优化 (如果有)
- 定期清理无用数据
- 添加适当的索引
- 配置数据库连接池

---

## 快捷命令参考

| 操作 | 命令 |
|------|------|
| 开发模式 | `npm run dev:weapp` / `npm run dev:h5` |
| 生产构建 | `npm run build:weapp` / `npm run build:h5` |
| 代码检查 | `npm run lint` |
| 类型检查 | `npm run type-check` |
| 部署重启 | `sudo systemctl reload nginx` |
| 查看日志 | `pm2 logs` |

---

## 版本管理

- **开发分支**: `develop` - 最新功能集成
- **生产分支**: `main` - 稳定发布版本
- **标签管理**: `git tag v1.0.0` - 标记发布版本

按照此方案，你可以完整地部署 IEClub 应用，实现网站和小程序的正常访问。

---

### 阶段二：开发与调试

#### 1. 启动开发模式
在项目根目录下，运行微信小程序的开发命令：
```bash
npm run dev:weapp
```
或者如果上面不行，尝试：
```bash
yarn dev:weapp
```

**成功标志：**
- 终端显示编译成功信息
- 出现 `监听文件修改中...` 提示
- 项目根目录下生成 `dist` 文件夹

#### 2. 检查编译产物
打开文件管理器，确认 `C:\universe\GitHub_try\IEclub_v1\dist` 文件夹已生成，里面应该包含：
- `app.js`
- `app.json` 
- `app.wxss`
- `pages/` 文件夹等

---

### 阶段三：微信开发者工具配置

#### 1. 打开微信开发者工具
- 启动微信开发者工具
- 扫码登录

#### 2. 导入项目
点击工具栏：
- **项目** → **导入项目**
- 在目录选择中，**选择 `dist` 文件夹**：
  `C:\universe\GitHub_try\IEclub_dev\dist`

- **AppID**：
  - 如果有正式 AppID，填写你的 AppID
  - 如果没有，选择"测试号"（功能受限）
  
- **项目名称**：可以命名为 "IEclub_v1_开发版"

- 点击**确定**

#### 3. 开发调试
- 左侧模拟器会显示小程序界面
- 可以在右侧进行代码调试、查看日志等
- **重要**：修改源代码要在 `src/` 目录下修改，Taro 会自动重新编译

---

### 阶段四：构建与上传

#### 1. 构建生产版本
当开发完成准备上传时，在项目根目录下运行：
```bash
npm run build:weapp
```
这会生成优化后的生产代码到 `dist/` 目录。

#### 2. 在微信开发者工具中上传
- 确保微信开发者工具中加载的是最新的 `dist` 内容
- 点击工具栏上的**上传**按钮
- 填写版本信息：
  - **版本号**：如 1.0.0
  - **项目备注**：如 "首次发布版本"

- 点击**上传**
- 输入你的小程序账号密码确认

---

### 阶段五：审核发布

#### 1. 登录微信公众平台
- 打开 [微信公众平台](https://mp.weixin.qq.com/)
- 扫码登录你的小程序账号

#### 2. 版本管理
- 进入 **管理** → **版本管理**
- 在"开发版本"中看到你刚上传的版本

#### 3. 提交审核
- 点击**提交审核**
- 按要求填写审核信息：
  - 测试账号（如果需要）
  - 小程序页面截图
  - 审核备注

- 提交后等待微信审核（通常1-3天）

#### 4. 发布上线
- 审核通过后，在"审核版本"中点击**发布**
- 小程序正式上线对用户开放

---

### 常见问题排查

#### 1. 如果 `npm run dev:weapp` 报错
- **错误**：`Error: Cannot find module ...`
  - 解决：删除 `node_modules` 文件夹和 `package-lock.json`，重新运行 `npm install`

- **错误**：`TypeError: ...`
  - 解决：检查 Taro 版本兼容性，可能需要升级：
    ```bash
    npm update @tarojs/cli @tarojs/taro
    ```

#### 2. 如果微信开发者工具无法加载
- 确认导入的是 `dist` 文件夹，不是项目根目录
- 检查 AppID 是否正确
- 在微信开发者工具中点击**工具** → **构建 npm**（如果项目使用了 npm 包）

#### 3. 如果页面显示异常
- 在微信开发者工具中点击**编译** → **全部重新编译**
- 检查终端中的编译错误信息
- 清除缓存：**工具** → **清除缓存** → **全部清除**

---

### 快捷命令总结
在项目根目录 `C:\universe\GitHub_try\IEclub_dev` 下：

| 操作 | 命令 |
|------|------|
| 安装依赖 | `npm install` |
| 开发模式 | `npm run dev:weapp` |
| 生产构建 | `npm run build:weapp` |
| H5开发 | `npm run dev:h5` |
| H5构建 | `npm run build:h5` |

按照这个流程，你应该能够顺利完成从开发到部署的整个流程。如果在某一步遇到具体问题，可以告诉我具体的错误信息，我会帮你进一步排查。


太棒了！这个问题标志着你已经进入了**专业产品发布的最后、也是最关键的环节——环境隔离与灰度发布**。

你现在的需求非常清晰：
1.  **环境隔离**：如何拥有一个普通用户访问不到，但团队成员可以访问的“内测环境”？
2.  **版本管理**：如何清晰地管理`开发中`、`内测中`、`已上线`这三个状态的代码？

我们将结合 **Git 分支策略** 和 **Nginx 部署策略** 来完美地实现这个目标。

---

### **第一部分：代码的版本管理 (Git Flow 的实战应用)**

我们之前讨论的 Git Flow 模型，现在可以精准地映射到你的需求上。

*   **开发中版本 -> `feature/*` 分支**
    *   **代码状态**：这是最不稳定、最新的代码。每个开发者都在自己的 `feature/xxx` 分支上进行独立的、并行的开发。
    *   **部署**：**不部署**。这些代码只存在于开发者的本地电脑上。
    *   **协作**：开发者之间通过 Pull Request 将各自完成的 `feature` 分支合并到 `develop` 分支。

*   **内测版本 -> `develop` 分支**
    *   **代码状态**：这是所有新功能**汇集、集成**后的版本。它代表了下一个即将发布的大版本的功能全集。功能上是完整的，但可能存在 Bug。
    *   **部署**：**部署到我们的“内测环境”**。这个环境就是专门用来给团队成员（产品经理、测试人员、其他开发者）测试和体验新功能的。
    *   **管理**：当 `develop` 分支有新的 `feature` 合并进来时，我们可以通过 GitHub Actions 自动触发部署到内测环境。

*   **已发布版本 -> `main` 分支 (通过 Git Tags)**
    *   **代码状态**：这是**最稳定**的版本。只有在 `develop` 分支上经过了充分的内测，修复了所有严重 Bug 后，才能被合并到 `main` 分支。
    *   **部署**：**部署到我们的“生产环境”（线上环境）**，也就是 `www.ieclub.online`。
    *   **管理**：每一次合并到 `main` 分支，都必须打上一个唯一的版本标签 (Tag)，如 `v1.0.0`, `v1.1.0` 等。这代表了一次正式的发布。



---

### **第二部分：环境的物理隔离 (服务器与 Nginx 部署)**

现在，最关键的问题来了：如何在一台服务器上，同时部署“内测环境”和“生产环境”，并让它们能被不同的人访问？

答案是：**使用子域名！**

#### **步骤 1：规划并设置 DNS**

我们将为内测环境创建一个专属的子域名。

1.  **生产环境 (线上)**
    *   **域名**: `www.ieclub.online`
    *   **API**: `api.ieclub.online` (推荐做法，将 API 独立出来)

2.  **内测环境 (Staging/Beta)**
    *   **域名**: `beta.ieclub.online`
    *   **API**: `api-beta.ieclub.online`

3.  **DNS 配置**
    *   登录你的域名提供商，添加**新的 A 记录**，将 `beta` 和 `api-beta` 这两个新的子域名，**全部指向你同一个服务器的 IP 地址**。

#### **步骤 2：在服务器上为内测环境创建独立的“家”**

我们需要为内测环境的代码、数据库、后端服务创建一套完全独立的副本。

1.  **代码目录**
    *   **生产代码**: `/var/www/ieclub_prod` (克隆自 `main` 分支)
    *   **内测代码**: `/var/www/ieclub_beta` (克隆自 `develop` 分支)

2.  **数据库**
    *   **生产数据库**: `ieclub_prod`
    *   **内测数据库**: `ieclub_beta` (新建一个完全独立的数据库，测试数据不会污染生产数据)
    *   你也需要为 `ieclub_beta` 数据库创建一个新的用户或使用同一个用户但授权给新库。

3.  **后端服务 (PM2)**
    *   **生产后端**：在 `3000` 端口运行，PM2 名称为 `ieclub-prod-backend`。
    *   **内测后端**：在 **另一个端口** (如 `3001`) 运行，PM2 名称为 `ieclub-beta-backend`。

#### **步骤 3：配置 Nginx - 担当“交通警察”的角色**

Nginx 将根据访问的域名，决定把用户引导到哪个环境。这是实现访问隔离的核心。

你需要创建**两个独立**的 Nginx 配置文件。

*   **`ieclub.online.conf` (生产环境配置)**
    ```nginx
    server {
        listen 443 ssl;
        server_name www.ieclub.online api.ieclub.online;
        
        # SSL 证书配置...

        # 生产环境前端
        location / {
            if ($host = 'www.ieclub.online') {
                root /var/www/ieclub_prod/ieclub-taro-project/dist/h5;
                try_files $uri $uri/ /index.html;
            }
        }

        # 生产环境后端
        location /api/ {
            if ($host = 'api.ieclub.online') {
                proxy_pass http://localhost:3000;
            }
        }
    }
    ```

*   **`beta.ieclub.online.conf` (内测环境配置)**
    ```nginx
    server {
        listen 443 ssl;
        server_name beta.ieclub.online api-beta.ieclub.online;

        # 为 beta 子域名也需要申请 SSL 证书
        # ...

        # 内测环境访问控制 (关键！)
        # 只允许特定 IP 访问
        allow 110.65.147.220;  # 假设这是你公司或测试人员的 IP
        allow 8.8.8.8;         # 允许另一个 IP
        deny all;              # 拒绝其他所有 IP

        # 内测环境前端
        location / {
            if ($host = 'beta.ieclub.online') {
                root /var/www/ieclub_beta/ieclub-taro-project/dist/h5;
                try_files $uri $uri/ /index.html;
            }
        }
        
        # 内测环境后端
        location /api/ {
            if ($host = 'api-beta.ieclub.online') {
                proxy_pass http://localhost:3001;
            }
        }
    }
    ```

**如何让公众无法访问内测环境？**
看到上面 `beta.ieclub.online.conf` 里的 `allow ...; deny all;` 了吗？这就是 Nginx 的访问控制功能。
*   `allow [IP地址];`: 创建一个白名单，只允许这些 IP 访问。你需要收集所有团队成员和测试人员的公网 IP 地址。
*   `deny all;`: 拒绝白名单之外的所有人。当普通用户尝试访问 `beta.ieclub.online` 时，Nginx 会直接返回一个 `403 Forbidden` 错误。

**另一种更灵活的认证方式是 `auth_basic`**，可以设置一个弹窗，要求输入用户名和密码才能访问。

#### **步骤 4：自动化部署流程 (GitHub Actions)**

现在，你的 CI/CD 流程也需要升级，以区分不同环境。

*   **`deploy-to-production.yml`**:
    *   **触发条件**: `on: push: branches: [ main ]`
    *   **部署逻辑**:
        *   SSH 登录服务器。
        *   `cd /var/www/ieclub_prod`
        *   `git pull origin main`
        *   部署 `ieclub-prod-backend` (端口 `3000`)。
        *   构建并部署前端到 `/var/www/ieclub_prod/.../dist/h5`。

*   **`deploy-to-beta.yml` (新建一个 Action 文件)**:
    *   **触发条件**: `on: push: branches: [ develop ]`
    *   **部署逻辑**:
        *   SSH 登录服务器。
        *   `cd /var/www/ieclub_beta`
        *   `git pull origin develop`
        *   部署 `ieclub-beta-backend` (端口 `3001`)，并使用**内测数据库**的配置。
        *   构建并部署前端到 `/var/www/ieclub_beta/.../dist/h5`。

---

### **总结：你的企业级发布全景规划**

1.  **代码层面 (Git)**:
    *   `feature/*` -> 本地开发 -> **不部署**
    *   `develop` -> 集成测试 -> **自动部署到 `beta.ieclub.online`**
    *   `main` + `tags` -> 稳定发布 -> **自动部署到 `www.ieclub.online`**

2.  **服务器层面 (物理)**:
    *   创建 `beta` 子域名并指向服务器。
    *   创建独立的**代码目录** (`ieclub_beta`)、**数据库** (`ieclub_beta`)、**后端服务** (`pm2` 在新端口 `3001` 运行)。

3.  **访问控制层面 (Nginx)**:
    *   创建两个 Nginx 配置文件，分别对应生产和内测域名。
    *   在内测环境的 Nginx 配置中，使用 **IP 白名单 (`allow/deny`)** 或**密码认证 (`auth_basic`)** 来阻止公众访问。

4.  **自动化层面 (CI/CD)**:
    *   创建两个 GitHub Actions 脚本。
    *   一个监听 `develop` 分支，部署到内测环境。
    *   一个监听 `main` 分支，部署到生产环境。

这套体系可以完美地满足你对版本隔离、内测流程和协作开发的所有需求，是你产品走向成熟和专业化的必经之路。