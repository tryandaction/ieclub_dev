# ==========================================================
# IEClub Nginx 测试环境配置扩展
# ==========================================================
#
# 用途: 为测试环境添加独立的 API 路由
# 方式: 通过路径前缀区分生产和测试环境
#
# 生产环境: https://ieclub.online/api -> 3000端口
# 测试环境: https://ieclub.online/api/staging -> 3001端口
#
# 更新: 2025-11-06
# ==========================================================

# 测试环境后端上游服务器
upstream ieclub_staging_backend {
    server 127.0.0.1:3001;
    keepalive 32;
}

# 在现有 server 块中添加以下配置

# ===== 测试环境 API =====
location /api/staging/ {
    # 重写路径，去掉 /staging 前缀
    rewrite ^/api/staging/(.*) /api/$1 break;
    
    proxy_pass http://ieclub_staging_backend;
    proxy_http_version 1.1;
    
    # 代理头
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Environment "staging";
    
    # 连接保持
    proxy_set_header Connection "";
    
    # 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # 缓冲设置
    proxy_buffering off;
    
    # 添加响应头标识
    add_header X-Environment "staging" always;
}

# ===== 测试环境健康检查 =====
location /health/staging {
    rewrite ^/health/staging$ /health break;
    proxy_pass http://ieclub_staging_backend;
    access_log off;
}

# ===== 测试环境上传文件访问 =====
location /uploads/staging/ {
    alias /root/IEclub_dev_staging/ieclub-backend/uploads/;
    
    # 安全设置
    add_header X-Content-Type-Options nosniff;
    add_header X-Environment "staging" always;
    
    # 缓存
    expires 30d;
    add_header Cache-Control "public";
}

# ==========================================================
# 使用说明
# ==========================================================
#
# 1. 将此配置内容添加到主 nginx 配置文件中的 server 块内
#    (通常是 /etc/nginx/sites-available/ieclub)
#
# 2. 测试配置:
#    nginx -t
#
# 3. 重启 Nginx:
#    systemctl reload nginx
#
# 4. 测试访问:
#    - 测试环境健康检查: https://ieclub.online/health/staging
#    - 测试环境 API: https://ieclub.online/api/staging/test
#    - 生产环境 API: https://ieclub.online/api/test (不变)
#
# ==========================================================

