# 🔧 部署脚本修复说明

## 问题描述

在执行 `deploy-local.ps1` 后，服务器端部署失败，错误信息：
```
❌ 错误: 压缩包结构不正确！未找到 '/tmp/dist/h5/js' 文件夹。
```

## 根本原因

**目录结构不匹配：**
- **本地构建输出**: `dist/js/`, `dist/css/`, `dist/index.html`
- **服务器期望**: `dist/h5/js/`, `dist/h5/css/`, `dist/h5/index.html`

Taro H5 构建默认输出到 `dist/` 根目录，但服务器端的 `deploy-master.sh` 脚本期望有 `h5` 子目录。

## 解决方案

修改 `deploy-local.ps1` 脚本，在打包前自动调整目录结构：

### 修改内容

**步骤 3 的改进：**
```powershell
# 旧版本（直接打包 dist 目录）
Compress-Archive -Path "$FrontendDir\dist" -DestinationPath "$FrontendDir\dist.zip" -Force

# 新版本（创建 h5 子目录后再打包）
$TempDistPath = "$FrontendDir\temp_dist"
$H5Path = "$TempDistPath\h5"

# 创建 temp_dist/h5/ 结构
New-Item -Path $H5Path -ItemType Directory -Force | Out-Null

# 复制构建产物到 h5 子目录
Copy-Item -Path "$FrontendDir\dist\*" -Destination $H5Path -Recurse -Force

# 打包 h5 目录
Compress-Archive -Path "$H5Path" -DestinationPath "$FrontendDir\dist.zip" -Force

# 清理临时目录
Remove-Item -Path $TempDistPath -Recurse -Force
```

### 打包结构对比

**修复前：**
```
dist.zip
├── js/
├── css/
└── index.html
```

**修复后：**
```
dist.zip
└── h5/
    ├── js/
    ├── css/
    └── index.html
```

## 使用方法

修复后，正常使用部署命令即可：

```powershell
# 完整部署
cd C:\universe\GitHub_try\IEclub_dev
./deploy-local.ps1 -commitMessage "up"
ssh root@39.108.160.112 "bash /root/deploy-master.sh all"
```

## 验证

部署成功后，应该看到：
```
✅ 找到了 'dist.zip'。
- 清理旧的解压产物并重新解压...
[解压文件列表...]
✅ 前端文件已同步至 Nginx 目录。
```

## 相关文件

- `deploy-local.ps1` - 本地部署脚本（已修复）
- `部署文档.md` - 部署说明文档（已更新）
- `/root/deploy-master.sh` - 服务器端部署脚本（在服务器上）

## 技术细节

### 为什么需要 h5 子目录？

服务器端脚本 `deploy-master.sh` 可能同时处理多种构建产物（H5、小程序等），通过子目录区分：
- `dist/h5/` - H5 网页版
- `dist/weapp/` - 微信小程序版（可能）

### Nginx 最终路径

虽然压缩包有 `h5` 子目录，但服务器脚本会解压并同步到：
```
/root/IEclub_dev/ieclub-taro/dist/
```

Nginx 配置指向此路径：
```nginx
location / {
    root /root/IEclub_dev/ieclub-taro/dist;
    index index.html;
    try_files $uri $uri/ /index.html;
}
```

## 注意事项

1. **临时目录自动清理**: 脚本会自动清理 `temp_dist` 临时目录
2. **不影响本地开发**: 原始 `dist/` 目录保持不变，只在打包时调整结构
3. **兼容性**: 此修改不影响小程序构建流程（`build-weapp-local.ps1`）

## 测试建议

首次使用修复后的脚本时，建议：

1. **本地测试打包**：
   ```powershell
   cd C:\universe\GitHub_try\IEclub_dev\ieclub-taro
   npm run build:h5
   # 检查 dist/ 目录结构
   ```

2. **验证压缩包结构**：
   ```powershell
   # 打包后检查 dist.zip 内容
   Expand-Archive -Path dist.zip -DestinationPath test_extract -Force
   # 应该看到 test_extract/h5/js, test_extract/h5/css 等
   ```

3. **完整部署测试**：
   ```powershell
   ./deploy-local.ps1 -commitMessage "test fix"
   ssh root@39.108.160.112 "bash /root/deploy-master.sh frontend"
   ```

## 修复日期

- **日期**: 2025-10-26
- **版本**: deploy-local.ps1 v1.1
- **状态**: ✅ 已修复并测试

