<!--pages/topic-detail/topic-detail.wxml-->
<view class="topic-detail-page">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="skeleton-header"></view>
    <view class="skeleton-title"></view>
    <view class="skeleton-content"></view>
    <view class="skeleton-content short"></view>
  </view>

  <!-- è¯é¢˜å†…å®¹ -->
  <view wx:elif="{{topic}}" class="topic-container">
    <!-- è¯é¢˜å¤´éƒ¨ -->
    <view class="topic-header" style="background: {{topic.typeColor || '#8b5cf6'}}">
      <view class="type-badge">
        <text class="type-icon">{{topic.typeIcon}}</text>
        <text class="type-label">{{topic.typeLabel}}</text>
      </view>
      <text class="topic-title">{{topic.title}}</text>
      <view class="topic-meta">
        <text class="views">ğŸ‘€ {{topic.viewsCount || 0}}</text>
        <text class="time">{{topic.formattedTime}}</text>
      </view>
    </view>

    <!-- ä½œè€…ä¿¡æ¯ -->
    <view class="author-card" bindtap="goToAuthor">
      <view class="author-left">
        <block wx:if="{{topic.author.avatar && topic.author.avatar.length > 2}}">
          <image class="author-avatar" src="{{topic.author.avatar}}" mode="aspectFill" />
        </block>
        <view wx:else class="author-avatar-placeholder">ğŸ‘¤</view>
        <view class="author-info">
          <view class="author-name-row">
            <text class="author-name">{{topic.author.nickname || 'åŒ¿åç”¨æˆ·'}}</text>
            <view wx:if="{{topic.author.level}}" class="author-level">LV{{topic.author.level}}</view>
          </view>
          <text class="author-bio">{{topic.author.bio || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~'}}</text>
        </view>
      </view>
      <text class="arrow">â€º</text>
    </view>

    <!-- è¯é¢˜å†…å®¹ -->
    <view class="topic-content">
      <text class="content-text">{{topic.content || topic.description}}</text>
    </view>

    <!-- æˆ‘æƒ³å¬/æˆ‘æ¥è®² ä¸“å±ä¿¡æ¯ -->
    <view wx:if="{{(topic.topicType === 'demand' || topic.topicType === 'offer') && (topic.duration || topic.targetAudience || topic.threshold)}}" class="extra-info-section">
      <view class="section-header">
        <text class="section-title">ğŸ“… è¯¦ç»†ä¿¡æ¯</text>
      </view>
      <view class="info-grid">
        <view wx:if="{{topic.duration}}" class="info-item">
          <text class="info-label">é¢„è®¡æ—¶é•¿</text>
          <text class="info-value">{{topic.duration}}</text>
        </view>
        <view wx:if="{{topic.targetAudience}}" class="info-item">
          <text class="info-label">ç›®æ ‡å¬ä¼—</text>
          <text class="info-value">{{topic.targetAudience}}</text>
        </view>
        <view wx:if="{{topic.threshold}}" class="info-item">
          <text class="info-label">æˆå›¢äººæ•°</text>
          <text class="info-value highlight">{{topic.threshold}} äºº</text>
        </view>
        <view wx:if="{{topic.wantToHearCount !== undefined}}" class="info-item">
          <text class="info-label">æƒ³å¬äººæ•°</text>
          <text class="info-value highlight-blue">{{topic.wantToHearCount}} äºº</text>
        </view>
      </view>
    </view>

    <!-- é¡¹ç›®ä¸“å±ä¿¡æ¯ -->
    <view wx:if="{{topic.topicType === 'project'}}" class="extra-info-section">
      <view class="section-header">
        <text class="section-title">ğŸš€ é¡¹ç›®ä¿¡æ¯</text>
      </view>
      <view class="info-grid">
        <view wx:if="{{topic.projectStage}}" class="info-item">
          <text class="info-label">é¡¹ç›®é˜¶æ®µ</text>
          <text class="info-value highlight-green">{{topic.projectStage}}</text>
        </view>
        <view wx:if="{{topic.teamSize}}" class="info-item">
          <text class="info-label">å›¢é˜Ÿè§„æ¨¡</text>
          <text class="info-value">{{topic.teamSize}} äºº</text>
        </view>
      </view>
      
      <!-- æ‹›å‹Ÿè§’è‰² -->
      <view wx:if="{{topic.lookingForRoles && topic.lookingForRoles.length > 0}}" class="roles-section">
        <text class="sub-label">æ‹›å‹Ÿè§’è‰²</text>
        <view class="roles-list">
          <text class="role-tag" wx:for="{{topic.lookingForRoles}}" wx:key="*this">{{item}}</text>
        </view>
      </view>
      
      <!-- æ‰€éœ€æŠ€èƒ½ -->
      <view wx:if="{{topic.skillsNeeded && topic.skillsNeeded.length > 0}}" class="skills-section">
        <text class="sub-label">æ‰€éœ€æŠ€èƒ½</text>
        <view class="skills-list">
          <text class="skill-tag" wx:for="{{topic.skillsNeeded}}" wx:key="*this">{{item}}</text>
        </view>
      </view>
      
      <!-- é“¾æ¥ -->
      <view wx:if="{{topic.website || topic.github || topic.contactInfo}}" class="links-section">
        <view wx:if="{{topic.website}}" class="link-item" bindtap="copyLink" data-link="{{topic.website}}">
          <text class="link-icon">ğŸŒ</text>
          <text class="link-text">é¡¹ç›®ç½‘ç«™</text>
        </view>
        <view wx:if="{{topic.github}}" class="link-item" bindtap="copyLink" data-link="{{topic.github}}">
          <text class="link-icon">ğŸ’»</text>
          <text class="link-text">GitHub</text>
        </view>
        <view wx:if="{{topic.contactInfo}}" class="link-item" bindtap="copyLink" data-link="{{topic.contactInfo}}">
          <text class="link-icon">ğŸ“§</text>
          <text class="link-text">{{topic.contactInfo}}</text>
        </view>
      </view>
    </view>

    <!-- æ ‡ç­¾ -->
    <view wx:if="{{topic.tags && topic.tags.length > 0}}" class="tags-container">
      <view class="tag-item" wx:for="{{topic.tags}}" wx:key="*this">
        <text class="tag-text">#{{item}}</text>
      </view>
    </view>

    <!-- ä¾›éœ€åŒ¹é…äº’åŠ¨åŒº -->
    <view wx:if="{{topic.topicType === 'demand' || topic.topicType === 'offer'}}" class="interaction-section">
      <view class="interaction-buttons">
        <view class="interaction-btn {{topic.userWantHear ? 'active blue' : ''}}" bindtap="handleWantHear">
          <text class="btn-icon">ğŸ‘‚</text>
          <text class="btn-label">æˆ‘æƒ³å¬</text>
          <text class="btn-count">{{topic.wantToHearCount || 0}}</text>
        </view>
        
        <view class="progress-circle">
          <view class="progress-num">{{topic.wantToHearCount || 0}}/{{topic.threshold || 15}}</view>
          <view class="progress-label">æˆå›¢è¿›åº¦</view>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{(topic.wantToHearCount || 0) / (topic.threshold || 15) * 100}}%"></view>
          </view>
        </view>
        
        <view class="interaction-btn {{topic.userCanTell ? 'active purple' : ''}}" bindtap="handleCanTell">
          <text class="btn-icon">ğŸ¤</text>
          <text class="btn-label">æˆ‘èƒ½è®²</text>
          <text class="btn-count">{{topic.canTellCount || 0}}</text>
        </view>
      </view>
      
      <view wx:if="{{topic.status === 'scheduled'}}" class="status-badge success">
        <text>ğŸ‰ å·²æˆå›¢ï¼ç­‰å¾…å¼€è®²å®‰æ’</text>
      </view>
    </view>

    <!-- é¡¹ç›®æ„Ÿå…´è¶£æŒ‰é’® -->
    <view wx:if="{{topic.topicType === 'project'}}" class="interaction-section project">
      <view class="project-interest-btn {{topic.userInterested ? 'active' : ''}}" bindtap="handleInterested">
        <text class="btn-icon">ğŸš€</text>
        <text class="btn-label">{{topic.userInterested ? 'å·²æ„Ÿå…´è¶£' : 'æ„Ÿå…´è¶£ï¼Œæƒ³åŠ å…¥'}}</text>
        <text class="btn-count">{{topic.interestedCount || 0}}</text>
      </view>
    </view>

    <!-- æ“ä½œæ  -->
    <view class="action-bar">
      <view class="action-item {{topic.isLiked ? 'active' : ''}}" bindtap="handleLike">
        <text class="action-icon">{{topic.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
        <text class="action-text">{{topic.likesCount || 0}}</text>
      </view>
      <view class="action-item" bindtap="handleBookmark">
        <text class="action-icon">{{topic.isBookmarked ? 'â­' : 'â˜†'}}</text>
        <text class="action-text">{{topic.isBookmarked ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
      </view>
      <view class="action-item">
        <text class="action-icon">ğŸ’¬</text>
        <text class="action-text">{{topic.commentsCount || 0}}</text>
      </view>
      <button class="action-item share-btn" open-type="share">
        <text class="action-icon">ğŸ”—</text>
        <text class="action-text">åˆ†äº«</text>
      </button>
    </view>

    <!-- è¯„è®ºåŒº -->
    <view class="comments-section">
      <view class="section-header">
        <text class="section-title">è¯„è®º ({{topic.commentsCount || 0}})</text>
      </view>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <view wx:if="{{comments.length > 0}}" class="comment-list">
        <view class="comment-item" wx:for="{{comments}}" wx:key="id">
          <view class="comment-header">
            <view class="comment-author" bindtap="goToAuthor" data-id="{{item.author.id}}">
              <block wx:if="{{item.author.avatar && item.author.avatar.length > 2}}">
                <image class="comment-avatar" src="{{item.author.avatar}}" mode="aspectFill" />
              </block>
              <view wx:else class="comment-avatar-placeholder">ğŸ‘¤</view>
              <view class="comment-author-info">
                <text class="comment-author-name">{{item.author.nickname || 'åŒ¿å'}}</text>
                <text class="comment-time">{{item.formattedTime}}</text>
              </view>
            </view>
            <view wx:if="{{item.author.id === currentUserId}}" class="comment-delete" catchtap="deleteComment" data-id="{{item.id}}" data-index="{{index}}">
              <text class="delete-icon">ğŸ—‘ï¸</text>
            </view>
          </view>
          <text class="comment-content">{{item.content}}</text>
          <view class="comment-actions">
            <view class="comment-action {{item.isLiked ? 'liked' : ''}}" catchtap="likeComment" data-id="{{item.id}}" data-index="{{index}}">
              <text class="action-icon">{{item.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
              <text class="action-count">{{item.likesCount || 0}}</text>
            </view>
            <view class="comment-action" catchtap="replyComment" data-comment="{{item}}">
              <text class="action-icon">ğŸ’¬</text>
              <text class="action-count">å›å¤</text>
            </view>
          </view>
        </view>
      </view>

      <!-- ç©ºè¯„è®ºçŠ¶æ€ -->
      <view wx:elif="{{!commentLoading}}" class="empty-comments">
        <text class="empty-icon">ğŸ’¬</text>
        <text class="empty-text">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘~</text>
      </view>

      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{commentLoading}}" class="loading-more">
        <text>åŠ è½½ä¸­...</text>
      </view>
      <view wx:elif="{{!hasMore && comments.length > 0}}" class="no-more">
        <text>æ²¡æœ‰æ›´å¤šè¯„è®ºäº†</text>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºè¾“å…¥æ¡† -->
  <view class="comment-input-bar">
    <view wx:if="{{replyTo}}" class="reply-hint">
      <text>å›å¤ @{{replyTo.author.nickname}}</text>
      <text class="cancel-reply" bindtap="cancelReply">å–æ¶ˆ</text>
    </view>
    <view class="input-row">
      <input 
        class="comment-input" 
        placeholder="{{isLogin ? 'å†™è¯„è®º...' : 'ç™»å½•åè¯„è®º'}}"
        value="{{commentContent}}"
        bindinput="onCommentInput"
        disabled="{{!isLogin}}"
        confirm-type="send"
        bindconfirm="submitComment"
      />
      <button 
        class="send-btn {{commentContent.trim() ? 'active' : ''}}" 
        bindtap="submitComment"
        disabled="{{submitting || !commentContent.trim()}}"
      >
        {{submitting ? 'å‘é€ä¸­' : 'å‘é€'}}
      </button>
    </view>
  </view>
</view>
