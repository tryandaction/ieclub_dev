# 本周开发任务（Week 1）

**时间**: 2025-10-29 ~ 2025-11-04  
**目标**: 完成基础设施搭建，实现用户登录功能

---

## 📅 Day 1-2: API 统一封装（今天开始！）

### 🎯 任务目标

创建统一的 API 请求封装层，为双端提供一致的数据请求接口。

---

### 📋 详细任务清单

#### Task 1.1: 网页版请求封装

**文件**: `ieclub-web/src/utils/request.js`

**功能需求**:
1. ✅ 基于 Axios 创建实例
2. ✅ 配置基础 URL
3. ✅ 请求拦截器（注入 Token）
4. ✅ 响应拦截器（统一处理）
5. ✅ 错误处理（网络错误、业务错误）
6. ✅ Loading 状态管理

**代码实现**:

```javascript
// ieclub-web/src/utils/request.js
import axios from 'axios'

// 创建 axios 实例
const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// 请求拦截器
request.interceptors.request.use(
  config => {
    // 注入 Token
    const token = localStorage.getItem('token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    
    // 显示 Loading（可选）
    if (config.loading !== false) {
      // 显示全局 Loading
      console.log('Loading start...')
    }
    
    return config
  },
  error => {
    console.error('Request error:', error)
    return Promise.reject(error)
  }
)

// 响应拦截器
request.interceptors.response.use(
  response => {
    // 隐藏 Loading
    console.log('Loading end...')
    
    const { code, data, message } = response.data
    
    // 业务成功
    if (code === 200) {
      return data
    }
    
    // Token 过期
    if (code === 401) {
      localStorage.removeItem('token')
      window.location.href = '/login'
      throw new Error('登录已过期，请重新登录')
    }
    
    // 业务失败
    throw new Error(message || '请求失败')
  },
  error => {
    // 隐藏 Loading
    console.log('Loading end...')
    
    // 网络错误
    if (!error.response) {
      throw new Error('网络连接失败，请检查网络')
    }
    
    // HTTP 错误
    const { status, data } = error.response
    
    switch (status) {
      case 400:
        throw new Error(data.message || '请求参数错误')
      case 401:
        localStorage.removeItem('token')
        window.location.href = '/login'
        throw new Error('登录已过期，请重新登录')
      case 403:
        throw new Error('没有权限访问')
      case 404:
        throw new Error('请求的资源不存在')
      case 500:
        throw new Error('服务器错误，请稍后重试')
      default:
        throw new Error(data.message || '请求失败')
    }
  }
)

export default request
```

**使用示例**:
```javascript
import request from '@/utils/request'

// GET 请求
const topics = await request.get('/topics', { 
  params: { page: 1, limit: 20 } 
})

// POST 请求
const result = await request.post('/topics', { 
  title: '标题',
  content: '内容'
})

// 不显示 Loading
const data = await request.get('/data', { loading: false })
```

---

#### Task 1.2: 小程序请求封装

**文件**: `ieclub-taro/utils/request.js`

**功能需求**:
1. ✅ 基于 wx.request 封装
2. ✅ Promise 化
3. ✅ 自动注入 Token
4. ✅ 统一错误处理
5. ✅ Loading 状态管理

**代码实现**:

```javascript
// ieclub-taro/utils/request.js

/**
 * 统一请求封装
 * @param {String} url - 请求地址
 * @param {Object} options - 请求选项
 * @param {String} options.method - 请求方法 GET/POST/PUT/DELETE
 * @param {Object} options.data - 请求数据
 * @param {Boolean} options.loading - 是否显示 Loading，默认 true
 * @returns {Promise}
 */
const request = (url, options = {}) => {
  const {
    method = 'GET',
    data = {},
    loading = true
  } = options

  // 显示 Loading
  if (loading) {
    wx.showLoading({
      title: '加载中...',
      mask: true
    })
  }

  return new Promise((resolve, reject) => {
    // 获取全局配置
    const app = getApp()
    const baseURL = app.globalData.apiBase || 'http://localhost:3000/api'
    
    // 获取 Token
    const token = wx.getStorageSync('token')

    wx.request({
      url: baseURL + url,
      method: method.toUpperCase(),
      data,
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
      },
      success: (res) => {
        // 隐藏 Loading
        if (loading) {
          wx.hideLoading()
        }

        const { statusCode, data } = res

        // HTTP 成功
        if (statusCode === 200) {
          const { code, data: responseData, message } = data

          // 业务成功
          if (code === 200) {
            resolve(responseData)
            return
          }

          // Token 过期
          if (code === 401) {
            wx.removeStorageSync('token')
            wx.showToast({
              title: '登录已过期',
              icon: 'none'
            })
            // 跳转到登录页
            setTimeout(() => {
              wx.reLaunch({
                url: '/pages/login/index'
              })
            }, 1500)
            reject(new Error('登录已过期'))
            return
          }

          // 业务失败
          wx.showToast({
            title: message || '请求失败',
            icon: 'none'
          })
          reject(new Error(message || '请求失败'))
          return
        }

        // HTTP 错误
        let errorMessage = '请求失败'
        
        switch (statusCode) {
          case 400:
            errorMessage = '请求参数错误'
            break
          case 401:
            errorMessage = '登录已过期'
            wx.removeStorageSync('token')
            setTimeout(() => {
              wx.reLaunch({
                url: '/pages/login/index'
              })
            }, 1500)
            break
          case 403:
            errorMessage = '没有权限访问'
            break
          case 404:
            errorMessage = '请求的资源不存在'
            break
          case 500:
            errorMessage = '服务器错误'
            break
        }

        wx.showToast({
          title: errorMessage,
          icon: 'none'
        })
        reject(new Error(errorMessage))
      },
      fail: (err) => {
        // 隐藏 Loading
        if (loading) {
          wx.hideLoading()
        }

        wx.showToast({
          title: '网络连接失败',
          icon: 'none'
        })
        reject(new Error('网络连接失败'))
      }
    })
  })
}

export default request
```

**使用示例**:
```javascript
import request from '../../utils/request'

// GET 请求
const topics = await request('/topics?page=1&limit=20')

// POST 请求
const result = await request('/topics', {
  method: 'POST',
  data: {
    title: '标题',
    content: '内容'
  }
})

// 不显示 Loading
const data = await request('/data', { loading: false })
```

---

#### Task 1.3: API 模块封装

**目的**: 将具体的 API 调用按模块组织，方便维护

**网页版**: `ieclub-web/src/api/`

```javascript
// ieclub-web/src/api/auth.js
import request from '@/utils/request'

// 发送验证码
export const sendCode = (phone) => {
  return request.post('/auth/send-code', { phone })
}

// 手机号登录
export const login = (phone, code) => {
  return request.post('/auth/login', { phone, code })
}

// 获取当前用户信息
export const getCurrentUser = () => {
  return request.get('/auth/me')
}

// 登出
export const logout = () => {
  return request.post('/auth/logout')
}
```

```javascript
// ieclub-web/src/api/topic.js
import request from '@/utils/request'

// 获取话题列表
export const getTopics = (params) => {
  return request.get('/topics', { params })
}

// 获取话题详情
export const getTopic = (id) => {
  return request.get(`/topics/${id}`)
}

// 创建话题
export const createTopic = (data) => {
  return request.post('/topics', data)
}

// 点赞话题
export const likeTopic = (id) => {
  return request.post(`/topics/${id}/like`)
}

// 取消点赞
export const unlikeTopic = (id) => {
  return request.delete(`/topics/${id}/like`)
}
```

**小程序版**: `ieclub-taro/api/`

```javascript
// ieclub-taro/api/auth.js
import request from '../utils/request'

// 微信登录
export const wechatLogin = (code) => {
  return request('/auth/wechat-login', {
    method: 'POST',
    data: { code }
  })
}

// 获取当前用户信息
export const getCurrentUser = () => {
  return request('/auth/me')
}
```

```javascript
// ieclub-taro/api/topic.js
import request from '../utils/request'

// 获取话题列表
export const getTopics = (params) => {
  const query = new URLSearchParams(params).toString()
  return request(`/topics?${query}`)
}

// 获取话题详情
export const getTopic = (id) => {
  return request(`/topics/${id}`)
}

// 创建话题
export const createTopic = (data) => {
  return request('/topics', {
    method: 'POST',
    data
  })
}

// 点赞话题
export const likeTopic = (id) => {
  return request(`/topics/${id}/like`, {
    method: 'POST'
  })
}

// 取消点赞
export const unlikeTopic = (id) => {
  return request(`/topics/${id}/like`, {
    method: 'DELETE'
  })
}
```

---

### ✅ Task 1 验收标准

**功能验收**:
- ✅ 网页版和小程序都能成功发起请求
- ✅ Token 自动注入到请求头
- ✅ 统一的错误提示
- ✅ Loading 状态正常显示和隐藏

**代码质量**:
- ✅ 代码结构清晰
- ✅ 注释完整
- ✅ 错误处理完善
- ✅ 易于扩展

**测试方法**:
```javascript
// 测试网页版
import { getTopics } from '@/api/topic'

try {
  const topics = await getTopics({ page: 1, limit: 20 })
  console.log('成功:', topics)
} catch (error) {
  console.error('失败:', error.message)
}

// 测试小程序
import { getTopics } from '../../api/topic'

getTopics({ page: 1, limit: 20 })
  .then(topics => {
    console.log('成功:', topics)
  })
  .catch(error => {
    console.error('失败:', error.message)
  })
```

---

## 📊 今日工作安排

### 上午（9:00-12:00）

1. **创建文件结构** (30分钟)
   ```bash
   # 网页版
   mkdir -p ieclub-web/src/utils
   mkdir -p ieclub-web/src/api
   touch ieclub-web/src/utils/request.js
   touch ieclub-web/src/api/auth.js
   touch ieclub-web/src/api/topic.js
   
   # 小程序
   mkdir -p ieclub-taro/utils
   mkdir -p ieclub-taro/api
   touch ieclub-taro/utils/request.js
   touch ieclub-taro/api/auth.js
   touch ieclub-taro/api/topic.js
   ```

2. **实现网页版请求封装** (1.5小时)
   - 完成 `request.js`
   - 测试基本功能

3. **实现网页版 API 模块** (1小时)
   - 完成 `api/auth.js`
   - 完成 `api/topic.js`

### 下午（14:00-18:00）

1. **实现小程序请求封装** (1.5小时)
   - 完成 `utils/request.js`
   - 测试基本功能

2. **实现小程序 API 模块** (1小时)
   - 完成 `api/auth.js`
   - 完成 `api/topic.js`

3. **联调测试** (1小时)
   - 测试网页版请求
   - 测试小程序请求
   - 确认双端一致性

4. **文档编写** (30分钟)
   - 更新使用文档
   - 记录注意事项

---

## 🎯 今日目标

- ✅ 完成双端 API 请求封装
- ✅ 完成基础 API 模块
- ✅ 通过所有测试
- ✅ 为明天的登录功能开发做好准备

---

## 💡 开发提示

### 调试技巧

**网页版**:
```javascript
// 在浏览器控制台测试
import request from '@/utils/request'

// 测试 GET
request.get('/api/test').then(console.log).catch(console.error)

// 测试 POST
request.post('/api/test', { data: 'test' })
  .then(console.log)
  .catch(console.error)
```

**小程序**:
```javascript
// 在页面的 onLoad 中测试
import request from '../../utils/request'

onLoad() {
  // 测试请求
  request('/test')
    .then(res => {
      console.log('成功:', res)
    })
    .catch(err => {
      console.error('失败:', err)
    })
}
```

### 常见问题

**Q: 跨域问题怎么解决？**  
A: 网页版开发环境在 `vite.config.js` 中已配置代理，生产环境需要后端配置 CORS

**Q: 小程序域名白名单？**  
A: 开发阶段可以在微信开发者工具中"不校验合法域名"，正式发布前需要在小程序管理后台配置

**Q: Token 存储安全吗？**  
A: 
- 网页版使用 localStorage，适合开发阶段
- 生产环境考虑使用 httpOnly Cookie
- 小程序的 wx.storage 是加密的，相对安全

---

**开始干活！Let's code! 💪**

