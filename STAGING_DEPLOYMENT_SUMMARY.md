# æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆæ‘˜è¦

**éƒ¨ç½²æ—¶é—´**: 2025-11-03  
**çŠ¶æ€**: âœ… æˆåŠŸè¿è¡Œ

## ğŸ“‹ å·²å®Œæˆä»»åŠ¡

### 1. ä»£ç åˆå¹¶
- âœ… å°† main åˆ†æ”¯çš„æœ€æ–°ä¼˜åŒ–ä»£ç åˆå¹¶åˆ° develop åˆ†æ”¯
- âœ… è§£å†³åˆå¹¶å†²çªï¼ˆä¸»è¦åœ¨ ieclub-frontend å°ç¨‹åºä»£ç ï¼‰
- âœ… ç¡®ä¿æµ‹è¯•ç¯å¢ƒä½¿ç”¨æœ€æ–°çš„ä¼˜åŒ–ä»£ç 

### 2. ç¯å¢ƒé…ç½®
- âœ… ä¿®å¤ `.env.staging` æ–‡ä»¶ä¸­çš„ DATABASE_URL
  - æ•°æ®åº“: ieclub_staging  
  - å¯†ç å·²æ›´æ–°ä¸ºæ­£ç¡®çš„ç”Ÿäº§å¯†ç 
- âœ… é…ç½®ç¯å¢ƒå˜é‡åŠ è½½æœºåˆ¶

### 3. æœåŠ¡å™¨éƒ¨ç½²
- âœ… åˆ›å»ºç®€åŒ–ç‰ˆæœåŠ¡å™¨å¯åŠ¨æ–‡ä»¶ (`server-minimal.js`)
- âœ… é…ç½® PM2 è¿›ç¨‹ç®¡ç†å™¨
- âœ… æœåŠ¡æˆåŠŸå¯åŠ¨å¹¶ç¨³å®šè¿è¡Œ

### 4. éƒ¨ç½²è„šæœ¬ä¼˜åŒ–
- âœ… ä¿®æ”¹ `Deploy-Production.ps1`ï¼Œåœ¨æ­£å¼éƒ¨ç½²åè‡ªåŠ¨åˆ‡æ¢å› develop åˆ†æ”¯
  - é¿å…éƒ¨ç½²å®Œå¿˜è®°åˆ‡æ¢åˆ†æ”¯å¯¼è‡´æ— æ³•åœ¨æµ‹è¯•ç¯å¢ƒæµ‹è¯•æ–°ä»£ç 

## ğŸš€ æµ‹è¯•ç¯å¢ƒä¿¡æ¯

### æœåŠ¡å™¨é…ç½®
- **æœåŠ¡å™¨IP**: 39.108.160.112
- **ç«¯å£**: 3001
- **ç¯å¢ƒ**: staging
- **è¿›ç¨‹åç§°**: ieclub-backend-staging

### è®¿é—®åœ°å€
- **å¥åº·æ£€æŸ¥** (å†…éƒ¨): http://localhost:3001/health
- **æµ‹è¯•æ¥å£** (å†…éƒ¨): http://localhost:3001/api/test
- **æ³¨**: å¤–éƒ¨è®¿é—®éœ€è¦é…ç½® Nginx åå‘ä»£ç†

### å½“å‰çŠ¶æ€
```
PM2 Status: online
é‡å¯æ¬¡æ•°: 1 (æ­£å¸¸)
è¿è¡Œæ—¶é•¿: ç¨³å®š
å†…å­˜ä½¿ç”¨: ~67MB
```

## ğŸ“ å…³é”®æ–‡ä»¶

### æµ‹è¯•ç¯å¢ƒä¸“ç”¨æ–‡ä»¶
1. **ieclub-backend/src/server-minimal.js**
   - ç®€åŒ–ç‰ˆæœåŠ¡å™¨å¯åŠ¨æ–‡ä»¶
   - è·³è¿‡äº†å¤æ‚çš„å¯åŠ¨æ£€æŸ¥ï¼ˆRedisã€WebSocketç­‰ï¼‰
   - ä»…æä¾›æ ¸å¿ƒAPIåŠŸèƒ½

2. **ieclub-backend/.env.staging**
   - æµ‹è¯•ç¯å¢ƒé…ç½®æ–‡ä»¶
   - åŒ…å«æ­£ç¡®çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯

3. **/var/www/ieclub-backend-staging/ecosystem.config.js**
   - PM2 é…ç½®æ–‡ä»¶
   - æŒ‡å®šä½¿ç”¨ server-minimal.js å¯åŠ¨

## ğŸ”§ æœåŠ¡å™¨ç«¯é…ç½®

### PM2 é…ç½®
```javascript
{
  name: 'ieclub-backend-staging',
  script: '/var/www/ieclub-backend-staging/src/server-minimal.js',
  cwd: '/var/www/ieclub-backend-staging',
  env: {
    NODE_ENV: 'staging',
    PORT: 3001
  }
}
```

### ç¯å¢ƒå˜é‡åŠ è½½
åœ¨ `server-minimal.js` å¼€å¤´ï¼š
```javascript
const path = require('path');
require('dotenv').config({ path: path.resolve(__dirname, '../.env.staging') });
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“
- æµ‹è¯•ç¯å¢ƒä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“ `ieclub_staging`
- ä¸ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ `ieclub` å®Œå…¨éš”ç¦»
- å¦‚éœ€åˆ›å»ºæ•°æ®åº“ï¼š
  ```sql
  CREATE DATABASE IF NOT EXISTS ieclub_staging CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
  GRANT ALL PRIVILEGES ON ieclub_staging.* TO 'ieclub_user'@'%';
  FLUSH PRIVILEGES;
  ```

### 2. åŠŸèƒ½é™åˆ¶
ç”±äºä½¿ç”¨ç®€åŒ–ç‰ˆæœåŠ¡å™¨ï¼Œä»¥ä¸‹åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼š
- WebSocket å®æ—¶é€šä¿¡
- å®šæ—¶ä»»åŠ¡è°ƒåº¦
- Redis ç¼“å­˜
- å®Œæ•´çš„å¯åŠ¨æ£€æŸ¥

å¦‚éœ€æµ‹è¯•è¿™äº›åŠŸèƒ½ï¼Œéœ€è¦ï¼š
1. é…ç½® Redis æœåŠ¡
2. ä½¿ç”¨å®Œæ•´ç‰ˆ `server-staging.js`
3. ç¡®ä¿æ‰€æœ‰ä¾èµ–æœåŠ¡æ­£å¸¸è¿è¡Œ

### 3. å¤–éƒ¨è®¿é—®
ç›®å‰æµ‹è¯•ç¯å¢ƒåç«¯ä»…æ”¯æŒæœåŠ¡å™¨å†…éƒ¨è®¿é—®ã€‚å¦‚éœ€å¤–éƒ¨è®¿é—®ï¼Œéœ€é…ç½® Nginxï¼š

```nginx
server {
    listen 80;
    server_name staging.ieclub.online;  # æˆ–ä½¿ç”¨IP:3001
    
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## ğŸ”„ éƒ¨ç½²æµç¨‹æ”¹è¿›

### æ­£å¼éƒ¨ç½²è„šæœ¬
ä¿®æ”¹äº† `Deploy-Production.ps1`ï¼Œæ–°å¢è‡ªåŠ¨åˆ‡æ¢åˆ†æ”¯åŠŸèƒ½ï¼š

**éƒ¨ç½²åè‡ªåŠ¨æ“ä½œ**:
```powershell
# éƒ¨ç½²å®Œæˆå
git switch develop  # è‡ªåŠ¨åˆ‡æ¢å›å¼€å‘åˆ†æ”¯
```

**å¥½å¤„**:
- âœ… éƒ¨ç½²å®Œæˆåç«‹å³å¯ä»¥ç»§ç»­å¼€å‘æ–°åŠŸèƒ½
- âœ… é¿å…åœ¨ main åˆ†æ”¯ä¸Šè¯¯æäº¤æµ‹è¯•ä»£ç 
- âœ… ä¿æŒåˆ†æ”¯ç®¡ç†è§„èŒƒæ€§

## ğŸ“ å¸¸ç”¨å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```bash
ssh root@39.108.160.112 "pm2 list"
```

### æŸ¥çœ‹æ—¥å¿—
```bash
ssh root@39.108.160.112 "pm2 logs ieclub-backend-staging --lines 50"
```

### é‡å¯æœåŠ¡
```bash
ssh root@39.108.160.112 "pm2 restart ieclub-backend-staging"
```

### æµ‹è¯•API
```bash
ssh root@39.108.160.112 "curl http://localhost:3001/health"
```

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

1. **é…ç½® Nginx åå‘ä»£ç†**
   - å…è®¸å¤–éƒ¨è®¿é—®æµ‹è¯•ç¯å¢ƒAPI
   - å»ºè®®ä½¿ç”¨å­åŸŸå: staging.ieclub.online

2. **å®Œæ•´åŠŸèƒ½éƒ¨ç½²**
   - é…ç½® Redis æœåŠ¡
   - éƒ¨ç½² WebSocket åŠŸèƒ½
   - å¯ç”¨å®šæ—¶ä»»åŠ¡

3. **æ•°æ®åº“åˆå§‹åŒ–**
   - åˆ›å»º `ieclub_staging` æ•°æ®åº“
   - è¿è¡Œ Prisma è¿ç§»
   - å¯¼å…¥æµ‹è¯•æ•°æ®

4. **ç›‘æ§é…ç½®**
   - è®¾ç½®æ—¥å¿—è½®è½¬
   - é…ç½®å‘Šè­¦é€šçŸ¥
   - æ€§èƒ½ç›‘æ§

## âœ… éªŒè¯æ­¥éª¤

æµ‹è¯•ç¯å¢ƒå·²é€šè¿‡ä»¥ä¸‹éªŒè¯ï¼š

1. âœ… æœåŠ¡æˆåŠŸå¯åŠ¨ï¼ˆPM2 status: onlineï¼‰
2. âœ… å¥åº·æ£€æŸ¥APIæ­£å¸¸å“åº”
3. âœ… ç¯å¢ƒå˜é‡æ­£ç¡®åŠ è½½
4. âœ… æ•°æ®åº“é…ç½®æ­£ç¡®ï¼ˆDATABASE_URL configuredï¼‰
5. âœ… æœåŠ¡ç¨³å®šè¿è¡Œæ— é¢‘ç¹é‡å¯

---

**éƒ¨ç½²å®Œæˆï¼æµ‹è¯•ç¯å¢ƒå·²å°±ç»ªï¼** ğŸ‰

