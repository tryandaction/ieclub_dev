// prisma/schema.prisma
// 数据库模型定义

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  
  // 登录认证 - 支持邮箱和微信小程序双登录
  email       String   @unique @db.VarChar(100)
  password    String   @db.VarChar(255) // 密码哈希
  openid      String?  @unique // 微信小程序openid（可选）
  unionid     String?  // 微信unionid（可选）
  sessionKey  String?  // 微信session_key（可选）

  // 基本信息
  nickname    String   @db.VarChar(50)
  avatar      String?  @default("") @db.Text // 头像可选
  gender      Int      @default(0) @db.TinyInt
  phone       String?  @unique @db.VarChar(20)
  bio         String?  @db.Text
  
  // 学校信息
  school      String?  @db.VarChar(100) // 学校
  major       String?  @db.VarChar(100) // 专业
  grade       String?  @db.VarChar(20)  // 年级
  verified    Boolean  @default(false)  // 是否认证

  // 技能和兴趣
  skills      String?  @db.Text // 技能标签数组 (JSON字符串)
  interests   String?  @db.Text // 兴趣标签数组 (JSON字符串)

  // 统计数据
  credits     Int      @default(0)
  level       Int      @default(1)
  exp         Int      @default(0)

  // 计数器
  topicsCount     Int @default(0)
  commentsCount   Int @default(0)
  likesCount      Int @default(0)
  fansCount       Int @default(0)
  followsCount    Int @default(0)

  // 状态
  status      String   @default("active") @db.VarChar(20) // active, banned, deleted
  isCertified Boolean  @default(false)
  isVip       Boolean  @default(false)

  // 时间戳
  lastLoginAt     DateTime?
  lastActiveAt    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // 关联关系
  topics          Topic[]
  projects        Project[]
  comments        Comment[]
  likes           Like[]
  bookmarks       Bookmark[]
  follows         Follow[] @relation("UserFollows")
  followers       Follow[] @relation("UserFollowers")
  sentNotifications     Notification[] @relation("NotificationSender")
  receivedNotifications Notification[] @relation("NotificationReceiver")
  userActions     UserAction[]
  topicQuickActions TopicQuickAction[]
  topicActions    TopicAction[]
  projectActions  ProjectAction[]
  activities      Activity[]
  activityParticipants ActivityParticipant[]
  activityLikes   ActivityLike[]
  activityComments ActivityComment[]

  @@map("users")
}

model Topic {
  id          String   @id @default(cuid())

  // 基本信息
  title       String   @db.VarChar(200)
  content     String   @db.LongText
  contentType String   @default("topic_offer") @db.VarChar(20) // topic_offer（我来讲）, topic_demand（想听）, project（项目宣传）
  summary     String?  @db.Text
  category    String   @db.VarChar(50)
  tags        String?  @db.Text // 标签数组 (JSON字符串)

  // 话题类型 - 融入开发代码的核心创新
  topicType   String   @default("discussion") @db.VarChar(20) // discussion, demand, supply, collaboration
  
    // 供需匹配机制 - 来自开发代码的15人成团创新
    demandType      String?  @db.VarChar(20) // 人员, 项目, 资金, 资源
    skillsNeeded    String?  @db.Text // 需要的技能 (JSON字符串)
    skillsProvided  String?  @db.Text // 提供的技能 (JSON字符串)
    threshold       Int      @default(15) // 成团阈值（默认15人）
    wantToHearCount Int      @default(0) // 想听人数
    canTellCount    Int      @default(0) // 我能讲人数
    status          String   @default("collecting") @db.VarChar(20) // collecting, scheduled, completed
  
    // 项目特有字段 - 项目宣传功能
    teamSize        Int?     // 团队规模
    lookingForRoles Json?    // 寻找的角色 (JSON数组)
    projectStage    String?  @db.VarChar(50) // 项目阶段
    website         String?  @db.VarChar(200)
    github          String?  @db.VarChar(200)
    interestedCount Int      @default(0) // 感兴趣人数
  
    // 时间安排 - 来自开发代码的功能
    duration        String?  @db.VarChar(50) // 预计时长
    targetAudience  String?  @db.Text // 目标听众
    scheduledTime   DateTime? // 安排时间
  deadline    DateTime?
  budget      String?  @db.VarChar(100)
  contactInfo String?  @db.Text

  // 媒体文件
  images      String?  @db.Text // 图片数组 (JSON字符串)
  documents   String?  @db.Text // 文档数组 (JSON字符串)
  videos      String?  @db.Text // 视频数组 (JSON字符串)
  links       String?  @db.Text // 链接数组 (JSON字符串)

  // 快速操作
  quickActions String? @db.Text // 快速操作配置 (JSON字符串)

  // 可见性
  visibility  String   @default("public") @db.VarChar(20) // public, private, followers

  // 统计数据
  viewsCount      Int @default(0)
  likesCount      Int @default(0)
  commentsCount   Int @default(0)
  bookmarksCount  Int @default(0)
  hotScore        Float @default(0)
  trendingScore   Float @default(0)
  isHot           Boolean @default(false)

  // 状态 - 融入开发代码的状态管理
  publishedAt DateTime?

  // 时间戳
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // 关联关系
  author       User @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId     String
  comments     Comment[]
  likes        Like[] @relation("LikeTopic")
  bookmarks    Bookmark[]
  notifications Notification[] @relation("NotificationTopic")
  userActions  UserAction[] @relation("UserActionTopic")
  quickActionsList TopicQuickAction[]
  actions      TopicAction[]

  @@map("topics")
}

model Comment {
  id          String   @id @default(cuid())

  // 评论内容
  content     String   @db.Text
  images      String?  @db.Text // 图片数组 (JSON字符串)

  // 评论层级
  parentId    String?  // 父评论ID
  rootId      String?  // 根评论ID（如果是回复）
  repliesCount Int     @default(0)

  // 统计数据
  likesCount  Int      @default(0)

  // 状态
  status      String   @default("published") @db.VarChar(20) // published, deleted

  // 时间戳
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联关系
  topic       Topic? @relation(fields: [topicId], references: [id], onDelete: Cascade)
  topicId     String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String?
  author      User @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId    String
  parent      Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies     Comment[] @relation("CommentReplies")
  likes       Like[] @relation("LikeComment")
  notifications Notification[] @relation("NotificationComment")

  @@map("comments")
}

model Like {
  id        String   @id @default(cuid())
  targetType String  @db.VarChar(20) // topic, comment
  targetId   String

  createdAt DateTime @default(now())

  // 关联关系
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  topic     Topic? @relation("LikeTopic", fields: [targetId], references: [id], map: "likes_topic_targetId_fkey")
  comment   Comment? @relation("LikeComment", fields: [targetId], references: [id], map: "likes_comment_targetId_fkey")

  @@unique([userId, targetType, targetId])
  @@map("likes")
}

model Bookmark {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // 关联关系
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  topic     Topic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  topicId   String

  @@unique([userId, topicId])
  @@map("bookmarks")
}

model Follow {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())

  // 关联关系
  follower    User @relation("UserFollows", fields: [followerId], references: [id], onDelete: Cascade)
  followerId  String
  following   User @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)
  followingId String

  @@unique([followerId, followingId])
  @@map("follows")
}

model Notification {
  id          String   @id @default(cuid())

  // 通知类型
  type        String   @db.VarChar(20) // like, comment, reply, follow, match, system

  // 通知内容
  title       String   @db.VarChar(100)
  content     String   @db.Text

  // 状态
  isRead      Boolean  @default(false)
  readAt      DateTime?

  // 跳转链接
  link        String?  @db.Text

  // 时间戳
  createdAt   DateTime @default(now())

  // 关联关系
  user        User @relation("NotificationReceiver", fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  actor       User? @relation("NotificationSender", fields: [actorId], references: [id])
  actorId     String?
  topic       Topic? @relation("NotificationTopic", fields: [targetId], references: [id], map: "notifications_topic_targetId_fkey")
  comment     Comment? @relation("NotificationComment", fields: [targetId], references: [id], map: "notifications_comment_targetId_fkey")
  targetType  String   @db.VarChar(20) // topic, comment, user
  targetId    String

  @@map("notifications")
}

model UserAction {
  id          String   @id @default(cuid())

  // 行为类型
  actionType  String   @db.VarChar(20) // view, like, comment, bookmark, click, share

  // 目标
  targetType  String   @db.VarChar(20) // topic, comment, user
  targetId    String

  // 元数据
  metadata    String?  @db.Text // 元数据 (JSON字符串)

  // 时间戳
  createdAt   DateTime @default(now())

  // 关联关系
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  topic       Topic? @relation("UserActionTopic", fields: [targetId], references: [id], map: "user_actions_topic_targetId_fkey")

  @@map("user_actions")
}

model TopicQuickAction {
  id          String   @id @default(cuid())

  // 操作类型
  actionType  String   @db.VarChar(20) // interested, can_help, want_collab

  // 时间戳
  createdAt   DateTime @default(now())

  // 关联关系
  topic       Topic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  topicId     String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  @@unique([topicId, userId, actionType])
  @@map("topic_quick_actions")
}

// ==================== 新增：话题互动表（来自开发代码） ====================
model TopicAction {
  id          String   @id @default(cuid())
  type        String   @db.VarChar(20) // like, want_hear, can_tell

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  topicId     String
  topic       Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([userId, topicId, type])
  @@index([userId])
  @@index([topicId])
  @@map("topic_actions")
}

// ==================== 新增：项目互动表（来自开发代码） ====================
model ProjectAction {
  id          String   @id @default(cuid())
  type        String   @db.VarChar(20) // like, interested

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([userId, projectId, type])
  @@index([userId])
  @@index([projectId])
  @@map("project_actions")
}

// ==================== 新增：项目表（来自开发代码） ====================
model Project {
  id              String      @id @default(cuid())
  category        String      @db.VarChar(50)
  title           String      @db.VarChar(200)
  description     String      @db.LongText
  tags            String?     @db.Text // JSON数组

  // 项目特有字段（来自开发代码）
  teamSize        Int?
  lookingForRoles Json?       // JSON数组
  projectStage    String?     @db.VarChar(50)
  website         String?     @db.VarChar(200)
  github          String?     @db.VarChar(200)

  // 统计数据
  viewCount       Int         @default(0)
  likeCount       Int         @default(0)
  commentCount    Int         @default(0)
  interestedCount Int         @default(0)

  // 媒体文件
  images          String?     @db.Text // JSON数组

  authorId        String
  author          User        @relation(fields: [authorId], references: [id])

  comments        Comment[]
  actions         ProjectAction[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([authorId])
  @@index([category])
  @@index([createdAt])
  @@map("projects")
}

// ==================== 新增：活动表 ====================
model Activity {
  id              String      @id @default(cuid())
  title           String      @db.VarChar(200)
  description     String      @db.LongText
  location        String      @db.VarChar(200)
  startTime       DateTime
  endTime         DateTime?
  maxParticipants Int?
  category        String      @db.VarChar(50)
  tags            String?     @db.Text // JSON数组
  cover           String?     @db.Text
  images          String?     @db.Text // JSON数组
  
  // 统计数据
  participantsCount Int       @default(0)
  likesCount        Int       @default(0)
  commentsCount     Int       @default(0)
  
  // 状态
  status          String      @default("published") @db.VarChar(20) // published, draft, deleted
  
  // 时间戳
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // 关联关系
  authorId        String
  author          User        @relation(fields: [authorId], references: [id])
  participants    ActivityParticipant[]
  likes           ActivityLike[]
  comments        ActivityComment[]
  
  @@index([authorId])
  @@index([category])
  @@index([startTime])
  @@index([status])
  @@index([createdAt])
  @@map("activities")
}

// ==================== 活动参与表 ====================
model ActivityParticipant {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  // 关联关系
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  activityId  String
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  
  @@unique([userId, activityId])
  @@index([userId])
  @@index([activityId])
  @@map("activity_participants")
}

// ==================== 活动点赞表 ====================
model ActivityLike {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  // 关联关系
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  activityId  String
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  
  @@unique([userId, activityId])
  @@index([userId])
  @@index([activityId])
  @@map("activity_likes")
}

// ==================== 活动评论表 ====================
model ActivityComment {
  id          String   @id @default(cuid())
  content     String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // 关联关系
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  activityId  String
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  
  @@index([authorId])
  @@index([activityId])
  @@index([createdAt])
  @@map("activity_comments")
}