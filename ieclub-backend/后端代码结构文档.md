# IEclub 后端代码结构文档

## 📁 项目根目录结构

```
ieclub-backend/
├── 📄 .env                    # 环境变量配置
├── 📄 .env.example           # 环境变量示例文件
├── 📄 docker-compose.yml     # Docker 编排配置
├── 📄 Dockerfile            # Docker 镜像构建文件
├── 📄 package.json          # 项目依赖和脚本配置
├── 📄 package-lock.json     # 依赖锁定文件
├── 📁 logs/                 # 日志文件目录
│   ├── 📄 .7e368ca8db1eec0e5e1aa78fc650dd864b722977-audit.json
│   ├── 📄 .0559a3255672595db09d3be3d405905ffb5e7d99-audit.json
│   ├── 📄 error-2025-10-16.log
│   └── 📄 ieclub-2025-10-16.log
├── 📁 prisma/               # 数据库相关文件
│   └── 📄 schema.prisma     # 数据库模型定义
├── 📁 src/                  # 源代码目录
│   ├── 📄 app.js           # Express 应用配置
│   ├── 📄 server.js        # 服务器启动文件
│   ├── 📁 config/          # 配置目录
│   │   └── 📄 index.js     # 统一配置管理
│   ├── 📁 controllers/     # 控制器层
│   │   ├── 📄 authController.js      # 用户认证控制器
│   │   ├── 📄 topicController.js     # 话题管理控制器
│   │   ├── 📄 commentController.js   # 评论管理控制器
│   │   ├── 📄 uploadController.js    # 文件上传控制器
│   │   ├── 📄 notificationController.js # 通知管理控制器
│   │   └── 📄 userController.js      # 用户管理控制器
│   ├── 📁 middleware/      # 中间件层
│   │   ├── 📄 auth.js              # JWT 认证中间件
│   │   ├── 📄 errorHandler.js      # 全局错误处理中间件
│   │   ├── 📄 upload.js            # 文件上传中间件
│   │   └── 📄 validation.js        # 请求验证中间件
│   ├── 📁 routes/          # 路由配置
│   │   └── 📄 index.js             # 主路由配置
│   ├── 📁 services/        # 服务层
│   │   ├── 📄 wechatService.js     # 微信小程序服务
│   │   ├── 📄 ossService.js        # 阿里云 OSS 文件服务
│   │   └── 📄 algorithmService.js  # 核心算法服务
│   ├── 📁 utils/           # 工具函数
│   │   ├── 📄 logger.js            # 日志工具
│   │   ├── 📄 redis.js             # Redis 缓存工具
│   │   └── 📄 response.js          # 统一响应格式工具
│   └── 📁 uploads/         # 本地临时文件目录
└── 📄 后端代码结构文档.md   # 本文档
```

## 🔧 核心文件功能详解

### 📋 配置文件

#### `package.json`
- **位置**: `ieclub-backend/package.json`
- **功能**:
  - 定义项目依赖包
  - 配置启动脚本（dev、start、test等）
  - 设置项目元信息（名称、版本、作者等）
- **关键依赖**:
  - `express`: Web 框架
  - `@prisma/client`: 数据库 ORM
  - `ioredis`: Redis 客户端
  - `jsonwebtoken`: JWT 令牌
  - `ali-oss`: 阿里云对象存储
  - `multer`: 文件上传处理

#### `src/config/index.js`
- **位置**: `ieclub-backend/src/config/index.js`
- **功能**:
  - 统一配置管理中心
  - 环境变量读取和验证
  - 业务规则配置（积分、热度算法等）
- **配置分类**:
  - 数据库配置（MySQL连接）
  - Redis 配置（缓存和队列）
  - JWT 配置（令牌密钥和过期时间）
  - 微信小程序配置（AppID、Secret）
  - OSS 配置（阿里云对象存储）
  - 业务规则配置（积分奖励、热度算法参数）

### 🚀 应用入口文件

#### `src/server.js`
- **位置**: `ieclub-backend/src/server.js`
- **功能**:
  - 服务器启动入口
  - 端口监听和错误处理
  - 优雅关闭处理
- **关键功能**:
  - 创建 HTTP 服务器
  - 监听指定端口
  - 处理服务器启动错误
  - 实现优雅关闭（SIGTERM、SIGINT）

#### `src/app.js`
- **位置**: `ieclub-backend/src/app.js`
- **功能**:
  - Express 应用配置
  - 中间件注册
  - 路由挂载
  - 静态文件服务
- **配置内容**:
  - CORS 配置
  - JSON 解析中间件
  - 全局错误处理
  - 路由中间件挂载

### 🎮 控制器层 (Controllers)

#### `authController.js` - 用户认证控制器
- **位置**: `ieclub-backend/src/controllers/authController.js`
- **主要功能**:
  - 微信小程序登录 (`wechatLogin`)
  - 用户信息获取 (`getCurrentUser`)
  - 用户信息更新 (`updateProfile`)
  - 每日签到功能 (`dailyCheckin`)
  - 用户退出登录 (`logout`)
- **核心业务**:
  - 微信授权码换取用户信息
  - JWT 令牌生成和刷新
  - 用户注册和登录状态管理
  - 积分奖励机制

#### `topicController.js` - 话题管理控制器
- **位置**: `ieclub-backend/src/controllers/topicController.js`
- **主要功能**:
  - 话题列表获取 (`getTopics`) - 支持筛选、排序、分页
  - 话题详情获取 (`getTopicDetail`) - 包含点赞、收藏状态
  - 话题创建 (`createTopic`) - 支持多种内容类型
  - 话题更新和删除 (`updateTopic`, `deleteTopic`)
  - 话题互动功能 (`toggleLike`, `toggleBookmark`, `quickAction`)
  - 个性化推荐 (`getRecommendTopics`)
  - 供需匹配推荐 (`getMatches`)
  - 趋势话题检测 (`getTrendingTopics`)
- **核心业务**:
  - 多维度话题筛选（分类、类型、标签、热度）
  - 热度算法集成
  - 用户行为记录和分析
  - 快速操作按钮统计

#### `commentController.js` - 评论管理控制器
- **位置**: `ieclub-backend/src/controllers/commentController.js`
- **主要功能**:
  - 评论列表获取 (`getComments`) - 支持嵌套回复
  - 评论回复获取 (`getReplies`)
  - 评论创建、更新、删除
  - 评论点赞功能 (`toggleLike`)
- **核心业务**:
  - 树形评论结构管理
  - 评论安全内容检测
  - 通知机制集成

#### `uploadController.js` - 文件上传控制器
- **位置**: `ieclub-backend/src/controllers/uploadController.js`
- **主要功能**:
  - 图片上传 (`uploadImages`) - 支持多图上传和缩略图生成
  - 文档上传 (`uploadDocuments`) - 支持 PDF、Word、PPT 等格式
  - 链接预览获取 (`getLinkPreview`) - OpenGraph 协议解析
  - 文件删除和签名生成
- **核心业务**:
  - 多媒体文件处理
  - OSS 云存储集成
  - 内容安全检测
  - 链接元数据提取

#### `notificationController.js` - 通知管理控制器
- **位置**: `ieclub-backend/src/controllers/notificationController.js`
- **主要功能**:
  - 通知列表获取 (`getNotifications`)
  - 未读通知统计 (`getUnreadCount`)
  - 通知标记已读
  - 通知删除功能
- **核心业务**:
  - 多类型通知管理（点赞、评论、关注等）
  - 通知状态管理
  - 批量操作支持

#### `userController.js` - 用户管理控制器
- **位置**: `ieclub-backend/src/controllers/userController.js`
- **主要功能**:
  - 用户资料获取 (`getUserProfile`)
  - 用户话题和评论列表
  - 用户关注功能 (`toggleFollow`)
  - 粉丝和关注列表管理
  - 个人内容管理（我的话题、收藏、点赞）
- **核心业务**:
  - 社交关系管理
  - 用户内容聚合
  - 隐私权限控制

### 🛠️ 中间件层 (Middleware)

#### `auth.js` - JWT 认证中间件
- **位置**: `ieclub-backend/src/middleware/auth.js`
- **主要功能**:
  - JWT 令牌验证 (`authenticate`)
  - 可选认证 (`optionalAuth`)
  - VIP 用户检查 (`requireVip`)
  - 认证用户检查 (`requireCertified`)
  - 令牌生成和刷新功能
- **核心功能**:
  - 多层次认证机制
  - 用户状态验证
  - 权限等级控制

#### `errorHandler.js` - 全局错误处理中间件
- **位置**: `ieclub-backend/src/middleware/errorHandler.js`
- **主要功能**:
  - 全局错误捕获和处理
  - Prisma 数据库错误处理
  - JWT 认证错误处理
  - 文件上传错误处理
  - 业务错误处理
- **核心功能**:
  - 统一错误响应格式
  - 错误日志记录
  - 开发/生产环境错误详情控制

#### `upload.js` - 文件上传中间件
- **位置**: `ieclub-backend/src/middleware/upload.js`
- **主要功能**:
  - 多文件上传处理 (`uploadMultipleImages`, `uploadMultipleDocuments`)
  - 文件类型和大小验证
  - 上传错误处理 (`handleUploadError`)
  - 文件信息提取工具
- **核心功能**:
  - Multer 配置和集成
  - 文件安全验证
  - 上传进度和错误管理

#### `validation.js` - 请求验证中间件
- **位置**: `ieclub-backend/src/middleware/validation.js`
- **主要功能**:
  - 微信登录验证 (`validateWechatLogin`)
  - 用户资料更新验证 (`validateUpdateProfile`)
  - 话题创建和更新验证 (`validateCreateTopic`, `validateUpdateTopic`)
  - 评论创建验证 (`validateCreateComment`)
  - 分页和通用验证规则
- **核心功能**:
  - Express-validator 集成
  - 多字段联合验证
  - 自定义验证规则

### 🔗 路由配置 (Routes)

#### `index.js` - 主路由配置
- **位置**: `ieclub-backend/src/routes/index.js`
- **主要功能**:
  - 所有控制器路由集成
  - 中间件链式配置
  - 路由参数验证
  - API 版本管理
- **路由分类**:
  - 认证路由 (`/auth/*`)
  - 话题路由 (`/topics/*`)
  - 评论路由 (`/comments/*`)
  - 上传路由 (`/upload/*`)
  - 通知路由 (`/notifications/*`)
  - 用户路由 (`/users/*`)
  - 搜索和健康检查路由

### 🔧 服务层 (Services)

#### `wechatService.js` - 微信小程序服务
- **位置**: `ieclub-backend/src/services/wechatService.js`
- **主要功能**:
  - 微信授权码换取用户信息 (`code2Session`)
  - 微信 Access Token 获取和管理
  - 订阅消息推送 (`sendSubscribeMessage`)
  - 小程序码生成 (`generateQRCode`)
  - 内容安全检测 (`msgSecCheck`, `imgSecCheck`)
- **核心功能**:
  - 微信官方 API 封装
  - Token 缓存机制
  - 安全检测集成

#### `ossService.js` - 阿里云 OSS 文件服务
- **位置**: `ieclub-backend/src/services/ossService.js`
- **主要功能**:
  - 图片上传和缩略图生成 (`uploadImages`)
  - 文档上传 (`uploadDocuments`)
  - 文件删除 (`deleteFile`)
  - 上传签名生成 (`getSignedUrl`)
- **核心功能**:
  - 云存储服务集成
  - 图片处理和优化
  - 直传签名机制

#### `algorithmService.js` - 核心算法服务
- **位置**: `ieclub-backend/src/services/algorithmService.js`
- **主要功能**:
  - 话题热度计算 (`calculateHotScore`)
  - 用户兴趣分析 (`calculateUserInterests`)
  - 个性化推荐算法 (`recommendTopics`)
  - 供需匹配算法 (`calculateMatchScore`, `matchRecommendation`)
  - 趋势话题检测 (`detectTrendingTopics`)
- **核心功能**:
  - 多维度热度算法
  - 协同过滤推荐
  - 智能匹配机制

### 🧰 工具函数 (Utils)

#### `logger.js` - 日志工具
- **位置**: `ieclub-backend/src/utils/logger.js`
- **主要功能**:
  - Winston 日志系统配置
  - 多级别日志记录
  - 日志文件轮转
  - 结构化日志输出
- **核心功能**:
  - 开发/生产环境日志控制
  - 日志持久化和管理

#### `redis.js` - Redis 缓存工具
- **位置**: `ieclub-backend/src/utils/redis.js`
- **主要功能**:
  - Redis 客户端配置
  - 缓存管理器封装
  - 缓存键生成工具
  - 批量操作支持
- **核心功能**:
  - 连接池管理
  - 缓存失效策略

#### `response.js` - 统一响应格式工具
- **位置**: `ieclub-backend/src/utils/response.js`
- **主要功能**:
  - 统一响应格式定义
  - 成功响应封装
  - 错误响应封装
  - 分页响应处理
- **核心功能**:
  - API 响应标准化
  - 错误码管理

### 💾 数据库模型

#### `schema.prisma` - 数据库模型定义
- **位置**: `ieclub-backend/prisma/schema.prisma`
- **主要功能**:
  - 用户模型定义 (User)
  - 话题模型定义 (Topic)
  - 评论模型定义 (Comment)
  - 点赞模型定义 (Like)
  - 收藏模型定义 (Bookmark)
  - 通知模型定义 (Notification)
  - 用户行为模型定义 (UserAction)
  - 推送任务模型定义 (PushTask)
- **核心特性**:
  - 完整的关系映射
  - 索引优化配置
  - 数据验证规则

## 🔄 API 接口概览

### 认证相关接口
- `POST /api/v1/auth/wechat-login` - 微信小程序登录
- `GET /api/v1/auth/me` - 获取当前用户信息
- `PUT /api/v1/auth/profile` - 更新用户资料
- `POST /api/v1/auth/daily-checkin` - 每日签到

### 话题相关接口
- `GET /api/v1/topics` - 获取话题列表（支持多维度筛选）
- `POST /api/v1/topics` - 创建话题
- `GET /api/v1/topics/:id` - 获取话题详情
- `POST /api/v1/topics/:id/like` - 点赞/取消点赞
- `POST /api/v1/topics/:id/bookmark` - 收藏/取消收藏
- `GET /api/v1/topics/recommend` - 获取推荐话题
- `GET /api/v1/topics/:id/matches` - 获取供需匹配

### 评论相关接口
- `GET /api/v1/topics/:topicId/comments` - 获取评论列表
- `POST /api/v1/topics/:topicId/comments` - 创建评论
- `POST /api/v1/comments/:id/like` - 点赞评论

### 文件上传接口
- `POST /api/v1/upload/images` - 上传图片
- `POST /api/v1/upload/documents` - 上传文档
- `POST /api/v1/upload/link-preview` - 获取链接预览

### 通知相关接口
- `GET /api/v1/notifications` - 获取通知列表
- `GET /api/v1/notifications/unread-count` - 获取未读数量
- `PUT /api/v1/notifications/:id/read` - 标记已读

### 用户相关接口
- `GET /api/v1/users/:id` - 获取用户信息
- `POST /api/v1/users/:id/follow` - 关注/取消关注
- `GET /api/v1/me/topics` - 获取我的话题
- `GET /api/v1/me/bookmarks` - 获取我的收藏

## 🎯 核心业务特色

### 1. 供需匹配系统
- 基于技能、兴趣、地点等多维度匹配
- 智能推荐算法
- 匹配度评分机制

### 2. 热度算法系统
- 时间衰减算法
- 多因素加权计算（浏览、点赞、评论、收藏）
- 实时热度更新

### 3. 个性化推荐系统
- 基于用户行为分析
- 协同过滤算法
- 多策略混合推荐

### 4. 内容安全系统
- 微信官方安全 API 集成
- 多层次内容检测
- 敏感词过滤机制

### 5. 实时通知系统
- 多类型通知支持
- 实时推送机制
- 通知状态管理

## 🚀 部署和运维

### 环境要求
- Node.js >= 18.0.0
- MySQL >= 8.0
- Redis >= 7.0
- 阿里云 OSS 账号（可选）

### 快速启动
```bash
# 1. 安装依赖
npm install

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 3. 初始化数据库
npm run prisma:generate
npm run prisma:migrate

# 4. 启动服务
npm run dev  # 开发模式
npm start    # 生产模式
```

### Docker 部署
```bash
# 构建镜像
docker build -t ieclub-backend .

# 启动服务
docker-compose up -d
```

## 📊 性能特点

### 高性能设计
- Redis 多级缓存策略
- 数据库查询优化
- 文件异步处理
- 集群部署支持

### 可扩展性
- 模块化架构设计
- 微服务就绪
- 配置驱动开发
- 插件化中间件

### 安全性
- 多层次认证机制
- 输入验证和过滤
- 敏感数据保护
- 安全头配置

---

**总结**: 这是一个功能完整、架构清晰、性能优秀的现代化后端系统，完全满足企业级应用的需求，具有良好的可维护性和扩展性。