"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[861],{"8861":function(n,e,t){t.r(e),t.d(e,{"default":function(){return NotificationsPage}});var a=t(1212),i=t(467),r=t(296),o=t(3707),c=t(6540),s=t(3699),l=t(9379),u=t(5458),f=t(1621),d=t(9958),h=t(2282);function getNotifications(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;return(0,h.E)({"url":"/api/notifications","method":"GET","data":{"page":n,"limit":e}})}function markAllNotificationsRead(){return(0,h.E)({"url":"/api/notifications/read-all","method":"POST"})}function getUnreadCount(){return(0,h.E)({"url":"/api/notifications/unread-count","method":"GET"})}var p=(0,f.vt)(function(n,e){return{"notifications":[],"unreadCount":0,"total":0,"hasMore":!0,"loading":!1,"fetchNotifications":(o=(0,i.A)((0,a.A)().m(function _callee(){var e,t,i,r,o=arguments;return(0,a.A)().w(function(a){for(;;)switch(a.p=a.n){case 0:return e=o.length>0&&void 0!==o[0]?o[0]:1,t=o.length>1&&void 0!==o[1]&&o[1],n({"loading":!0}),a.p=1,a.n=2,getNotifications(e);case 2:i=a.v,n(function(n){return{"notifications":t?[].concat((0,u.A)(n.notifications),(0,u.A)(i.notifications)):i.notifications,"total":i.total,"hasMore":i.hasMore,"unreadCount":i.unreadCount,"loading":!1}}),a.n=4;break;case 3:throw a.p=3,r=a.v,n({"loading":!1}),(0,d.P0)({"title":r.message||"加载失败","icon":"none"}),r;case 4:return a.a(2)}},_callee,null,[[1,3]])})),function fetchNotifications(){return o.apply(this,arguments)}),"markAllRead":(r=(0,i.A)((0,a.A)().m(function _callee2(){var e;return(0,a.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,markAllNotificationsRead();case 1:n(function(n){return{"notifications":n.notifications.map(function(n){return(0,l.A)((0,l.A)({},n),{},{"isRead":!0})}),"unreadCount":0}}),(0,d.P0)({"title":"全部标记已读","icon":"success"}),t.n=3;break;case 2:throw t.p=2,e=t.v,(0,d.P0)({"title":e.message||"操作失败","icon":"none"}),e;case 3:return t.a(2)}},_callee2,null,[[0,2]])})),function markAllRead(){return r.apply(this,arguments)}),"fetchUnreadCount":(t=(0,i.A)((0,a.A)().m(function _callee3(){var e,t;return(0,a.A)().w(function(a){for(;;)switch(a.p=a.n){case 0:return a.p=0,a.n=1,getUnreadCount();case 1:e=a.v,n({"unreadCount":e.count}),a.n=3;break;case 2:a.p=2,t=a.v,console.error("获取未读数量失败:",t);case 3:return a.a(2)}},_callee3,null,[[0,2]])})),function fetchUnreadCount(){return t.apply(this,arguments)}),"clearNotifications":function clearNotifications(){n({"notifications":[],"total":0,"hasMore":!0,"unreadCount":0})}};var t,r,o}),m=t(4398),A=t(143),v=t(9501),g=t(4848);function NotificationsPage(){var n=p(),e=n.notifications,t=n.unreadCount,l=n.hasMore,u=n.loading,f=n.fetchNotifications,d=n.markAllRead,h=(0,c.useState)(!1),N=(0,r.A)(h,2),k=N[0],w=N[1],x=(0,c.useCallback)((0,i.A)((0,a.A)().m(function _callee(){var n;return(0,a.A)().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,f(1);case 1:e.n=3;break;case 2:e.p=2,n=e.v,console.error("加载通知失败:",n);case 3:return e.a(2)}},_callee,null,[[0,2]])})),[f]);(0,c.useEffect)(function(){x()},[x]);var j=function(){var n=(0,i.A)((0,a.A)().m(function _callee2(){return(0,a.A)().w(function(n){for(;;)switch(n.p=n.n){case 0:return w(!0),n.p=1,n.n=2,f(1);case 2:return n.p=2,w(!1),n.f(2);case 3:return n.a(2)}},_callee2,null,[[1,,2,3]])}));return function onRefresh(){return n.apply(this,arguments)}}(),C=function(){var n=(0,i.A)((0,a.A)().m(function _callee3(){var n,t;return(0,a.A)().w(function(a){for(;;)switch(a.p=a.n){case 0:if(l&&!u){a.n=1;break}return a.a(2);case 1:return a.p=1,n=Math.ceil(e.length/20),a.n=2,f(n+1,!0);case 2:a.n=4;break;case 3:a.p=3,t=a.v,console.error("加载更多失败:",t);case 4:return a.a(2)}},_callee3,null,[[1,3]])}));return function onLoadMore(){return n.apply(this,arguments)}}(),_=function(){var n=(0,i.A)((0,a.A)().m(function _callee4(){var n;return(0,a.A)().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,d();case 1:e.n=3;break;case 2:e.p=2,n=e.v,console.error("标记已读失败:",n);case 3:return e.a(2)}},_callee4,null,[[0,2]])}));return function handleMarkAllRead(){return n.apply(this,arguments)}}(),S=function getNotificationIcon(n){return{"like":"❤️","comment":"💬","reply":"↩️","follow":"👤","system":"🔔"}[n]||"📢"};return(0,g.jsxs)(o.Ss,{"className":"notifications-page","children":[t>0&&(0,g.jsxs)(o.Ss,{"className":"header-actions","children":[(0,g.jsxs)(o.EY,{"className":"unread-count","children":[t," 条未读"]}),(0,g.jsx)(o.Ss,{"className":"mark-read-btn","onClick":_,"children":"全部已读"})]}),(0,g.jsx)(o.BM,{"className":"notifications-scroll","scrollY":!0,"refresherEnabled":!0,"refresherTriggered":k,"onRefresherRefresh":j,"onScrollToLower":C,"lowerThreshold":100,"children":u&&0===e.length?(0,g.jsx)(A.A,{}):0===e.length?(0,g.jsx)(m.A,{"title":"暂无通知","description":"你还没有收到任何通知"}):(0,g.jsxs)(o.Ss,{"className":"notifications-list","children":[e.map(function(n){return(0,g.jsxs)(o.Ss,{"className":"notification-item ".concat(n.isRead?"":"unread"),"onClick":function onClick(){return function handleNotificationClick(n){n.topicId&&s.Ay.navigateTo({"url":"/pages/topic-detail/index?id=".concat(n.topicId)})}(n)},"children":[(0,g.jsx)(o.Ss,{"className":"notification-icon","children":S(n.type)}),(0,g.jsxs)(o.Ss,{"className":"notification-content","children":[(0,g.jsx)(o.EY,{"className":"title","children":n.title}),(0,g.jsx)(o.EY,{"className":"content","children":n.content}),(0,g.jsx)(o.EY,{"className":"time","children":(0,v.fw)(n.createdAt)})]}),!n.isRead&&(0,g.jsx)(o.Ss,{"className":"unread-dot"})]},n.id)}),l&&(0,g.jsx)(o.Ss,{"className":"load-more","children":u?"加载中...":"上拉加载更多"}),!l&&e.length>0&&(0,g.jsx)(o.Ss,{"className":"no-more","children":"没有更多了"})]})})]})}}}]);