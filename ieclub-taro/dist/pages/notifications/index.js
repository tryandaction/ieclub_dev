"use strict";(wx["webpackJsonp"]=wx["webpackJsonp"]||[]).push([[613],{9376:function(n,t,e){var r=e(7842),i=e(3949),a=e(6784),o=e(8140),c=e(118),s=e(8833),u=e(758),l=e.n(u),f=e(5006),h=e(8500),d=e(1621),p=e(9732);function m(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;return(0,p.E)({url:"/api/notifications",method:"GET",data:{page:n,limit:t}})}function v(){return(0,p.E)({url:"/api/notifications/read-all",method:"POST"})}function w(){return(0,p.E)({url:"/api/notifications/unread-count",method:"GET"})}var A=(0,d.vt)(function(n,t){return{notifications:[],unreadCount:0,total:0,hasMore:!0,loading:!1,fetchNotifications:function(){var t=(0,a.A)((0,i.A)().m(function t(){var e,r,a,o,c=arguments;return(0,i.A)().w(function(t){while(1)switch(t.p=t.n){case 0:return e=c.length>0&&void 0!==c[0]?c[0]:1,r=c.length>1&&void 0!==c[1]&&c[1],n({loading:!0}),t.p=1,t.n=2,m(e);case 2:a=t.v,n(function(n){return{notifications:r?[].concat((0,h.A)(n.notifications),(0,h.A)(a.notifications)):a.notifications,total:a.total,hasMore:a.hasMore,unreadCount:a.unreadCount,loading:!1}}),t.n=4;break;case 3:throw t.p=3,o=t.v,n({loading:!1}),l().showToast({title:o.message||"\u52a0\u8f7d\u5931\u8d25",icon:"none"}),o;case 4:return t.a(2)}},t,null,[[1,3]])}));function e(){return t.apply(this,arguments)}return e}(),markAllRead:function(){var t=(0,a.A)((0,i.A)().m(function t(){var e;return(0,i.A)().w(function(t){while(1)switch(t.p=t.n){case 0:return t.p=0,t.n=1,v();case 1:n(function(n){return{notifications:n.notifications.map(function(n){return(0,f.A)((0,f.A)({},n),{},{isRead:!0})}),unreadCount:0}}),l().showToast({title:"\u5168\u90e8\u6807\u8bb0\u5df2\u8bfb",icon:"success"}),t.n=3;break;case 2:throw t.p=2,e=t.v,l().showToast({title:e.message||"\u64cd\u4f5c\u5931\u8d25",icon:"none"}),e;case 3:return t.a(2)}},t,null,[[0,2]])}));function e(){return t.apply(this,arguments)}return e}(),fetchUnreadCount:function(){var t=(0,a.A)((0,i.A)().m(function t(){var e,r;return(0,i.A)().w(function(t){while(1)switch(t.p=t.n){case 0:return t.p=0,t.n=1,w();case 1:e=t.v,n({unreadCount:e.count}),t.n=3;break;case 2:t.p=2,r=t.v,console.error("\u83b7\u53d6\u672a\u8bfb\u6570\u91cf\u5931\u8d25:",r);case 3:return t.a(2)}},t,null,[[0,2]])}));function e(){return t.apply(this,arguments)}return e}(),clearNotifications:function(){n({notifications:[],total:0,hasMore:!0,unreadCount:0})}}}),g=e(8179),x=e(6330),N=e(4416),j=e(5349);function k(){var n=A(),t=n.notifications,e=n.unreadCount,r=n.hasMore,u=n.loading,f=n.fetchNotifications,h=n.markAllRead,d=(0,s.useState)(!1),p=(0,o.A)(d,2),m=p[0],v=p[1],w=function(){var n=(0,a.A)((0,i.A)().m(function n(){var t;return(0,i.A)().w(function(n){while(1)switch(n.p=n.n){case 0:return n.p=0,n.n=1,f(1);case 1:n.n=3;break;case 2:n.p=2,t=n.v,console.error("\u52a0\u8f7d\u901a\u77e5\u5931\u8d25:",t);case 3:return n.a(2)}},n,null,[[0,2]])}));return function(){return n.apply(this,arguments)}}();(0,s.useEffect)(function(){w()},[w]);var k=function(){var n=(0,a.A)((0,i.A)().m(function n(){return(0,i.A)().w(function(n){while(1)switch(n.p=n.n){case 0:return v(!0),n.p=1,n.n=2,f(1);case 2:return n.p=2,v(!1),n.f(2);case 3:return n.a(2)}},n,null,[[1,,2,3]])}));return function(){return n.apply(this,arguments)}}(),S=function(){var n=(0,a.A)((0,i.A)().m(function n(){var e,a;return(0,i.A)().w(function(n){while(1)switch(n.p=n.n){case 0:if(r&&!u){n.n=1;break}return n.a(2);case 1:return n.p=1,e=Math.ceil(t.length/20),n.n=2,f(e+1,!0);case 2:n.n=4;break;case 3:n.p=3,a=n.v,console.error("\u52a0\u8f7d\u66f4\u591a\u5931\u8d25:",a);case 4:return n.a(2)}},n,null,[[1,3]])}));return function(){return n.apply(this,arguments)}}(),b=function(){var n=(0,a.A)((0,i.A)().m(function n(){var t;return(0,i.A)().w(function(n){while(1)switch(n.p=n.n){case 0:return n.p=0,n.n=1,h();case 1:n.n=3;break;case 2:n.p=2,t=n.v,console.error("\u6807\u8bb0\u5df2\u8bfb\u5931\u8d25:",t);case 3:return n.a(2)}},n,null,[[0,2]])}));return function(){return n.apply(this,arguments)}}(),T=function(n){n.topicId&&l().navigateTo({url:"/pages/topic-detail/index?id=".concat(n.topicId)})},C=function(n){var t={like:"\u2764\ufe0f",comment:"\ud83d\udcac",reply:"\u21a9\ufe0f",follow:"\ud83d\udc64",system:"\ud83d\udd14"};return t[n]||"\ud83d\udce2"};return(0,j.jsxs)(c.Ss,{className:"notifications-page",children:[e>0&&(0,j.jsxs)(c.Ss,{className:"header-actions",children:[(0,j.jsxs)(c.EY,{className:"unread-count",children:[e," \u6761\u672a\u8bfb"]}),(0,j.jsx)(c.Ss,{className:"mark-read-btn",onClick:b,children:"\u5168\u90e8\u5df2\u8bfb"})]}),(0,j.jsx)(c.BM,{className:"notifications-scroll",scrollY:!0,refresherEnabled:!0,refresherTriggered:m,onRefresherRefresh:k,onScrollToLower:S,lowerThreshold:100,children:u&&0===t.length?(0,j.jsx)(x.A,{}):0===t.length?(0,j.jsx)(g.A,{title:"\u6682\u65e0\u901a\u77e5",description:"\u4f60\u8fd8\u6ca1\u6709\u6536\u5230\u4efb\u4f55\u901a\u77e5"}):(0,j.jsxs)(c.Ss,{className:"notifications-list",children:[t.map(function(n){return(0,j.jsxs)(c.Ss,{className:"notification-item ".concat(n.isRead?"":"unread"),onClick:function(){return T(n)},children:[(0,j.jsx)(c.Ss,{className:"notification-icon",children:C(n.type)}),(0,j.jsxs)(c.Ss,{className:"notification-content",children:[(0,j.jsx)(c.EY,{className:"title",children:n.title}),(0,j.jsx)(c.EY,{className:"content",children:n.content}),(0,j.jsx)(c.EY,{className:"time",children:(0,N.fw)(n.createdAt)})]}),!n.isRead&&(0,j.jsx)(c.Ss,{className:"unread-dot"})]},n.id)}),r&&(0,j.jsx)(c.Ss,{className:"load-more",children:u?"\u52a0\u8f7d\u4e2d...":"\u4e0a\u62c9\u52a0\u8f7d\u66f4\u591a"}),!r&&t.length>0&&(0,j.jsx)(c.Ss,{className:"no-more",children:"\u6ca1\u6709\u66f4\u591a\u4e86"})]})})]})}var S={navigationBarTitleText:"\u901a\u77e5",enablePullDownRefresh:!1};Page((0,r.createPageConfig)(k,"pages/notifications/index",{root:{cn:[]}},S||{}))}},function(n){var t=function(t){return n(n.s=t)};n.O(0,[907,96,76],function(){return t(9376)});n.O()}]);