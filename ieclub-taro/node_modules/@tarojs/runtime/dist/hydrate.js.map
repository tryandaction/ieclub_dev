{"version":3,"file":"hydrate.js","sources":["../../src/hydrate.ts"],"sourcesContent":["import { hooks, Shortcuts, toCamelCase } from '@tarojs/shared'\n\nimport {\n  CATCH_VIEW,\n  CATCHMOVE,\n  CLASS,\n  CLICK_VIEW,\n  COMPILE_MODE,\n  ID,\n  PURE_VIEW,\n  STYLE,\n  VIEW\n} from './constants'\nimport { getComponentsAlias, isComment, isHasExtractProp, isText } from './utils'\n\nimport type { TaroElement } from './dom/element'\nimport type { TaroText } from './dom/text'\nimport type { MiniData, MiniElementData } from './interface'\n\nlet SPECIAL_NODES\nlet componentsAlias\n\n/**\n * React also has a fancy function's name for this: `hydrate()`.\n * You may have been heard `hydrate` as a SSR-related function,\n * actually, `hydrate` basicly do the `render()` thing, but ignore some properties,\n * it's a vnode traverser and modifier: that's exactly what Taro's doing in here.\n */\nexport function hydrate (node: TaroElement | TaroText): MiniData {\n  // 初始化 componentsAlias\n  componentsAlias ||= getComponentsAlias()\n\n  // 初始化 SPECIAL_NODES\n  SPECIAL_NODES ||= hooks.call('getSpecialNodes')!\n\n  const nodeName = node.nodeName\n  let compileModeName = null\n\n  if (isText(node)) {\n    return {\n      sid: node.sid,\n      [Shortcuts.Text]: node.nodeValue,\n      [Shortcuts.NodeName]: componentsAlias[nodeName]?._num || '8'\n    }\n  }\n\n  const data: MiniElementData = {\n    [Shortcuts.NodeName]: nodeName,\n    sid: node.sid\n  }\n\n  if (node.uid !== node.sid) {\n    data.uid = node.uid\n  }\n\n  if (SPECIAL_NODES.indexOf(nodeName) > -1) {\n    if (!node.isAnyEventBinded()) {\n      data[Shortcuts.NodeName] = `static-${nodeName}`\n      if (nodeName === VIEW && !isHasExtractProp(node)) {\n        data[Shortcuts.NodeName] = PURE_VIEW\n      }\n    }\n\n    if (nodeName === VIEW && node.isOnlyClickBinded() && !isHasExtractProp(node)) {\n      data[Shortcuts.NodeName] = CLICK_VIEW\n    }\n  }\n\n  const { props } = node\n  for (const prop in props) {\n    const propInCamelCase = toCamelCase(prop)\n    if (\n      !prop.startsWith('data-') && // 在 node.dataset 的数据\n      prop !== CLASS &&\n      prop !== STYLE &&\n      prop !== ID &&\n      propInCamelCase !== CATCHMOVE &&\n      propInCamelCase !== COMPILE_MODE\n    ) {\n      data[propInCamelCase] = props[prop]\n    }\n    if (\n      process.env.TARO_ENV !== 'swan' &&\n      nodeName === VIEW &&\n      propInCamelCase === CATCHMOVE &&\n      props[prop] !== false\n    ) {\n      data[Shortcuts.NodeName] = CATCH_VIEW\n    }\n    if (propInCamelCase === COMPILE_MODE) {\n      compileModeName = props[prop]\n    }\n  }\n\n  // Children\n  data[Shortcuts.Childnodes] = node.childNodes.filter(node => !isComment(node)).map(hydrate)\n\n  if (node.className !== '') {\n    data[Shortcuts.Class] = node.className\n  }\n\n  const cssText = node.cssText\n  if (cssText !== '' && nodeName !== 'swiper-item') {\n    data[Shortcuts.Style] = cssText\n  }\n\n  hooks.call('modifyHydrateData', data, node)\n\n  const nn = data[Shortcuts.NodeName]\n  const componentAlias = componentsAlias[nn]\n  if (componentAlias) {\n    data[Shortcuts.NodeName] = componentAlias._num\n    for (const prop in data) {\n      if (prop in componentAlias) {\n        data[componentAlias[prop]] = data[prop]\n        delete data[prop]\n      }\n    }\n  }\n\n  if (compileModeName !== null) {\n    data[Shortcuts.NodeName] = compileModeName\n  }\n\n  const resData = hooks.call('transferHydrateData', data, node, componentAlias)\n\n  return resData || data\n}\n"],"names":[],"mappings":"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"}