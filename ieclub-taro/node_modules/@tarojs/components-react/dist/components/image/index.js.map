{"version":3,"file":"index.js","sources":["../../../src/components/image/index.tsx"],"sourcesContent":["import './style/index.scss'\n\nimport classNames from 'classnames'\n\nimport { createForwardRefComponent } from '../../utils'\nimport { useCallback, useEffect, useRef, useState } from '../../utils/hooks'\n\nimport type React from 'react'\n\ninterface IProps extends React.HTMLAttributes<HTMLDivElement> {\n  src: string\n  mode: string\n  onError: () => void\n  onLoad: (e) => void\n  lazyLoad?: boolean\n  imgProps?: Record<string, any>\n  forwardedRef?: React.MutableRefObject<HTMLDivElement>\n  lang?: string\n}\n\n// CDN脚本URL\nconst LEGO_CDN_URL = 'http://ossin.jd.com/swm-plus/h5Tag/tag.js'\n\n// 检查CDN脚本是否已加载\nconst isLegoScriptLoaded = (): boolean => {\n  return document.querySelector(`script[src=\"${LEGO_CDN_URL}\"]`) !== null\n}\n\n// 插入CDN脚本\nconst insertLegoScript = (): void => {\n  if (isLegoScriptLoaded()) return\n\n  const script = document.createElement('script')\n  script.type = 'module'\n  script.src = LEGO_CDN_URL\n  document.head.appendChild(script)\n}\n\n// 解析lego协议URL\nconst parseLegoUrl = (src: string): { tagId: string, text: string } | null => {\n  if (!src.startsWith('lego://')) return null\n\n  try {\n    // 移除 'lego://' 前缀\n    const urlWithoutProtocol = src.substring(7)\n\n    // 分割tagId和参数\n    const [tagId, params] = urlWithoutProtocol.split('?')\n\n    // 解析参数\n    const text = params ? new URLSearchParams(params).get('text') || '' : ''\n\n    return { tagId, text }\n  } catch (error) {\n    console.warn('Failed to parse lego URL:', src, error)\n    return null\n  }\n}\n\nfunction Image (props: IProps) {\n  const imgRef = useRef<HTMLImageElement | null>(null)\n  const observer = useRef<Partial<IntersectionObserver>>({})\n  const [, setIsLoaded] = useState(false)\n  const {\n    className,\n    style = {},\n    src,\n    mode,\n    onError,\n    lazyLoad,\n    imgProps,\n    forwardedRef,\n    lang,\n    ...reset\n  } = props\n\n  // 检查是否为lego模式\n  const legoData = parseLegoUrl(src)\n  const isLegoMode = legoData !== null\n\n  // 如果是lego模式，确保CDN脚本已加载\n  useEffect(() => {\n    if (isLegoMode) {\n      insertLegoScript()\n    }\n  }, [isLegoMode])\n\n  const cls = classNames(\n    'taro-img',\n    {\n      'taro-img__widthfix': mode === 'widthFix'\n    },\n    className\n  )\n  const imgCls = classNames(\n    'taro-img__mode-' +\n      (mode || 'scaleToFill').toLowerCase().replace(/\\s/g, '')\n  )\n\n  const imageOnLoad = useCallback((e) => {\n    const { onLoad } = props\n    Object.defineProperty(e, 'detail', {\n      enumerable: true,\n      writable: true,\n      value: {\n        width: e.target.width,\n        height: e.target.height\n      }\n    })\n\n    onLoad && onLoad(e)\n  }, [props])\n\n  useEffect(() => {\n    if (lazyLoad) {\n      observer.current = new IntersectionObserver(\n        entries => {\n          // 异步 api 关系\n          if (entries[entries.length - 1].isIntersecting) {\n            setIsLoaded(true)\n            // findDOMNode(this).children[0].src = src\n            imgRef.current!.src = src\n          }\n        },\n        {\n          rootMargin: '300px 0px'\n        }\n      )\n      observer.current.observe?.(imgRef.current!)\n    }\n\n    return () => {\n      observer.current?.disconnect?.()\n    }\n  }, [lazyLoad, src])\n\n  // 如果是lego模式，渲染canvas-tag\n  if (isLegoMode && legoData) {\n    return (\n      <div className={cls} style={style} ref={forwardedRef} {...reset}>\n        <canvas-tag\n          tagId={legoData.tagId}\n          text={legoData.text}\n          lang={lang}\n          {...imgProps}\n        />\n      </div>\n    )\n  }\n\n  // 普通图片模式\n  return (\n    <div className={cls} style={style} ref={forwardedRef} {...reset}>\n      {lazyLoad ? (\n        <img\n          ref={img => (imgRef.current = img)}\n          className={imgCls}\n          data-src={src}\n          onLoad={imageOnLoad}\n          onError={onError}\n          {...imgProps}\n        />\n      ) : (\n        <img\n          ref={img => (imgRef.current = img)}\n          className={imgCls}\n          src={src}\n          onLoad={imageOnLoad}\n          onError={onError}\n          {...imgProps}\n        />\n      )}\n    </div>\n  )\n}\n\nexport default createForwardRefComponent(Image)\n"],"names":["LEGO_CDN_URL","isLegoScriptLoaded","document","querySelector","insertLegoScript","script","createElement","type","src","head","appendChild","parseLegoUrl","startsWith","urlWithoutProtocol","substring","tagId","params","split","text","URLSearchParams","get","error","console","warn","Image","props","imgRef","useRef","observer","setIsLoaded","useState","className","style","mode","onError","lazyLoad","imgProps","forwardedRef","lang","reset","__rest","legoData","isLegoMode","useEffect","cls","classNames","imgCls","toLowerCase","replace","imageOnLoad","useCallback","e","onLoad","Object","defineProperty","enumerable","writable","value","width","target","height","current","IntersectionObserver","entries","length","isIntersecting","rootMargin","_b","_a","observe","call","disconnect","_jsx","ref","children","img","createForwardRefComponent"],"mappings":"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"}