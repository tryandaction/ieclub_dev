# IEClub H5 éƒ¨ç½²è„šæœ¬ (Windows PowerShell)
# ä¿®å¤ç‰ˆæœ¬ - åŒ…å«æœåŠ¡å™¨ç«¯æ›´æ–°æ­¥éª¤

Write-Host "ğŸš€ å¼€å§‹ IEClub H5 éƒ¨ç½²æµç¨‹..." -ForegroundColor Cyan

# ==================== æœ¬åœ°æ“ä½œ ====================

# 1. è¿›å…¥å‰ç«¯é¡¹ç›®ç›®å½•
Write-Host "`nğŸ“ æ­¥éª¤ 1: è¿›å…¥å‰ç«¯ç›®å½•..." -ForegroundColor Yellow
cd C:\universe\GitHub_try\IEclub_dev\ieclub-taro

# 2. æ¸…ç†æ—§æ„å»ºäº§ç‰©
Write-Host "`nğŸ§¹ æ­¥éª¤ 2: æ¸…ç†æ—§æ„å»ºäº§ç‰©..." -ForegroundColor Yellow
if (Test-Path dist) {
    Remove-Item -Path dist -Recurse -Force
    Write-Host "âœ… å·²æ¸…ç† dist ç›®å½•" -ForegroundColor Green
}

# 3. æ„å»º H5 ç‰ˆæœ¬
Write-Host "`nğŸ”¨ æ­¥éª¤ 3: æ„å»º H5 ç‰ˆæœ¬..." -ForegroundColor Yellow
npm run build:h5

if ($LASTEXITCODE -ne 0) {
    Write-Host "âŒ æ„å»ºå¤±è´¥ï¼" -ForegroundColor Red
    exit 1
}
Write-Host "âœ… H5 æ„å»ºå®Œæˆ" -ForegroundColor Green

# 4. æ‰“åŒ… dist ç›®å½•
Write-Host "`nğŸ“¦ æ­¥éª¤ 4: æ‰“åŒ… dist ç›®å½•..." -ForegroundColor Yellow
if (Test-Path dist.zip) {
    Remove-Item dist.zip -Force
}
Compress-Archive -Path dist -DestinationPath dist.zip -Force
Write-Host "âœ… æ‰“åŒ…å®Œæˆ: dist.zip" -ForegroundColor Green

# 5. ä¸Šä¼ åˆ°æœåŠ¡å™¨
Write-Host "`nğŸ“¤ æ­¥éª¤ 5: ä¸Šä¼ åˆ°æœåŠ¡å™¨..." -ForegroundColor Yellow
scp dist.zip root@39.108.160.112:/tmp/

if ($LASTEXITCODE -ne 0) {
    Write-Host "âŒ ä¸Šä¼ å¤±è´¥ï¼" -ForegroundColor Red
    exit 1
}
Write-Host "âœ… ä¸Šä¼ å®Œæˆ" -ForegroundColor Green

# ==================== æœåŠ¡å™¨æ“ä½œ ====================

Write-Host "`nğŸ–¥ï¸  æ­¥éª¤ 6: æ‰§è¡ŒæœåŠ¡å™¨ç«¯æ›´æ–°..." -ForegroundColor Yellow

# é€šè¿‡ SSH æ‰§è¡ŒæœåŠ¡å™¨ç«¯å‘½ä»¤
ssh root@39.108.160.112 @"
echo 'ğŸ”„ å¼€å§‹æœåŠ¡å™¨ç«¯æ›´æ–°...'

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /root/IEclub_dev/ieclub-taro

# å¤‡ä»½å½“å‰ç‰ˆæœ¬
if [ -d dist ]; then
    echo 'ğŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬...'
    mv dist dist_backup_\$(date +%Y%m%d_%H%M%S)
fi

# è§£å‹æ–°ç‰ˆæœ¬
echo 'ğŸ“‚ è§£å‹æ–°ç‰ˆæœ¬...'
unzip -o /tmp/dist.zip -d .

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm /tmp/dist.zip

# é‡å¯ Nginxï¼ˆå¦‚æœéœ€è¦ï¼‰
echo 'ğŸ”„ é‡å¯ Nginx...'
nginx -s reload

echo 'âœ… æœåŠ¡å™¨ç«¯æ›´æ–°å®Œæˆï¼'
"@

if ($LASTEXITCODE -ne 0) {
    Write-Host "âŒ æœåŠ¡å™¨æ›´æ–°å¤±è´¥ï¼" -ForegroundColor Red
    exit 1
}

# ==================== å®Œæˆ ====================

Write-Host "`nâœ¨ éƒ¨ç½²å®Œæˆï¼" -ForegroundColor Green
Write-Host "ğŸŒ è®¿é—®åœ°å€: http://39.108.160.112" -ForegroundColor Cyan
Write-Host "ğŸ’¡ æç¤º: å¦‚æœæµè§ˆå™¨ä»æ˜¾ç¤ºæ—§ç‰ˆæœ¬ï¼Œè¯·æŒ‰ Ctrl+F5 å¼ºåˆ¶åˆ·æ–°" -ForegroundColor Yellow
