# IEClub H5 部署脚本 (Windows PowerShell)
# 修复版本 - 包含服务器端更新步骤

Write-Host "🚀 开始 IEClub H5 部署流程..." -ForegroundColor Cyan

# ==================== 本地操作 ====================

# 1. 进入前端项目目录
Write-Host "`n📁 步骤 1: 进入前端目录..." -ForegroundColor Yellow
cd C:\universe\GitHub_try\IEclub_dev\ieclub-taro

# 2. 清理旧构建产物
Write-Host "`n🧹 步骤 2: 清理旧构建产物..." -ForegroundColor Yellow
if (Test-Path dist) {
    Remove-Item -Path dist -Recurse -Force
    Write-Host "✅ 已清理 dist 目录" -ForegroundColor Green
}

# 3. 构建 H5 版本
Write-Host "`n🔨 步骤 3: 构建 H5 版本..." -ForegroundColor Yellow
npm run build:h5

if ($LASTEXITCODE -ne 0) {
    Write-Host "❌ 构建失败！" -ForegroundColor Red
    exit 1
}
Write-Host "✅ H5 构建完成" -ForegroundColor Green

# 4. 打包 dist 目录
Write-Host "`n📦 步骤 4: 打包 dist 目录..." -ForegroundColor Yellow
if (Test-Path dist.zip) {
    Remove-Item dist.zip -Force
}
Compress-Archive -Path dist -DestinationPath dist.zip -Force
Write-Host "✅ 打包完成: dist.zip" -ForegroundColor Green

# 5. 上传到服务器
Write-Host "`n📤 步骤 5: 上传到服务器..." -ForegroundColor Yellow
scp dist.zip root@39.108.160.112:/tmp/

if ($LASTEXITCODE -ne 0) {
    Write-Host "❌ 上传失败！" -ForegroundColor Red
    exit 1
}
Write-Host "✅ 上传完成" -ForegroundColor Green

# ==================== 服务器操作 ====================

Write-Host "`n🖥️  步骤 6: 执行服务器端更新..." -ForegroundColor Yellow

# 通过 SSH 执行服务器端命令
ssh root@39.108.160.112 @"
echo '🔄 开始服务器端更新...'

# 进入项目目录
cd /root/IEclub_dev/ieclub-taro

# 备份当前版本
if [ -d dist ]; then
    echo '📦 备份当前版本...'
    mv dist dist_backup_\$(date +%Y%m%d_%H%M%S)
fi

# 解压新版本
echo '📂 解压新版本...'
unzip -o /tmp/dist.zip -d .

# 清理临时文件
rm /tmp/dist.zip

# 重启 Nginx（如果需要）
echo '🔄 重启 Nginx...'
nginx -s reload

echo '✅ 服务器端更新完成！'
"@

if ($LASTEXITCODE -ne 0) {
    Write-Host "❌ 服务器更新失败！" -ForegroundColor Red
    exit 1
}

# ==================== 完成 ====================

Write-Host "`n✨ 部署完成！" -ForegroundColor Green
Write-Host "🌐 访问地址: http://39.108.160.112" -ForegroundColor Cyan
Write-Host "💡 提示: 如果浏览器仍显示旧版本，请按 Ctrl+F5 强制刷新" -ForegroundColor Yellow
